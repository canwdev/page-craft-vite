import{C as e}from"./CommonNavbar-BN_veBGg.js";import{d as t,t as a,Y as n,r as l,P as s,e as i,p as o,y as r,i as c,k as d,v as u,f as p,a1 as m,o as h,I as v,c as y,g,F as b,h as f,U as w,Q as k,m as _,aH as j,bF as x,bG as C,z as $,V as I,Z as T,_ as E,bH as A,bI as D,aQ as H,ak as S,u as U,bJ as P,ai as R,G as F,R as O,O as N,T as L,$ as q,w as G,ag as J,bK as M,A as B,aF as V,a8 as z,X as K,K as Q}from"./index-BJklM7uy.js";/* empty css                        *//* empty css                      *//* empty css                   *//* empty css                   */import{c as W,b as X}from"./base64-utils-DyHxpBV2.js";import{_ as Y}from"./MarkdownRender.vue_vue_type_script_setup_true_lang-5feYFoeZ.js";import{a as Z,u as ee,m as te,A as ae,g as ne,c as le,d as se}from"./use-common-ai-C7HWWNsI.js";import{u as ie}from"./useIDBKeyval-vbfvgNrE.js";import{a as oe}from"./prompts-BZAjZ4TJ.js";/* empty css                        */import{_ as re}from"./index.vue_vue_type_script_setup_true_lang-CqCeVzfa.js";import{A as ce}from"./enum-CdO7LyZZ.js";import{r as de}from"./renders-CF-5Gesb.js";import{_ as ue}from"./index.vue_vue_type_style_index_0_lang-B7OiTwk5.js";/* empty css                  */import"./enum-wriI_ogO.js";import"./RectSwitch-Dpia0p_L.js";import"./use-model-wrapper-Cm8bqa9M.js";/* empty css                    */import"./set-Clims6tx.js";import"./index-BB5hC_Ln.js";const pe=t({__name:"TextContent",props:{isDark:{type:Boolean,default:!1},isEditing:{type:Boolean,default:!1},text:{default:""}},emits:["update:text"],setup(e,{emit:t}){const v=e,{text:y,isEditing:g}=a(v),b=n(v,"text",t),f=l();return s(g,(()=>{setTimeout((()=>{f.value&&(f.value.scrollIntoView({behavior:"smooth"}),f.value.focus())}))})),(e,t)=>r(g)?(h(),i("div",{key:0,class:c(["chat-content vp-bg",{"markdown-body-dark":e.isDark}]),style:{width:"100%",padding:"0",display:"flex","border-radius":"2px"}},[d(p("textarea",{class:"vp-input font-code","onUpdate:modelValue":t[0]||(t[0]=e=>m(b)?b.value=e:null),rows:"14",ref_key:"editInputRef",ref:f,style:{width:"100%","font-size":"14px","box-sizing":"border-box"}},null,512),[[u,r(b)]])],2)):(h(),o(Y,{key:1,class:"chat-content vp-bg",dark:e.isDark,text:r(b)},null,8,["dark","text"]))}}),me=["innerHTML"],he={class:"chat-side"},ve={class:"chat-header"},ye=["title"],ge=["src","alt"],be={key:1},fe={key:1,class:"chat-username"},we={key:2,class:"chat-username _character"},ke={style:{width:"50px",height:"50px"},"element-loading-background":"transparent"},_e={key:0,class:"chat-images"},je={class:"chat-actions"},xe={key:0,class:"chat-date font-code"},Ce=E(t({__name:"ChatBubble",props:{isDark:{type:Boolean,default:!1},allowDelete:{type:Boolean,default:!1},allowEdit:{type:Boolean},allowRetry:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},character:{},item:{}},emits:["delete","retry"],setup(e,{emit:t}){const n=t,m=e,{item:E,character:A}=a(m),{t:D}=v(),H=l(!1),S=l();s(H,(()=>{setTimeout((()=>{S.value&&(S.value.scrollIntoView({behavior:"smooth"}),S.value.focus())}))}));const U=y((()=>"assistant"===E.value.role)),P=y((()=>A.value&&A.value.avatar)),R=l(),F=()=>{const e=R.value;e.parentElement.scrollTo({top:e.offsetTop-10,behavior:"smooth"})},O=()=>{const e=R.value,t=e.parentElement;t.scrollTo({top:e.offsetTop+e.offsetHeight-t.offsetHeight+10,behavior:"smooth"})},N=y((()=>{if(!E.value)return[];if(Array.isArray(E.value.content)){const e=E.value.content,t=[];return e.forEach((e=>{const{type:a,image_url:n}=e;"image_url"===a&&t.push(n)})),t}return[]})),L=y((()=>N.value.map((e=>e.url)))),q=()=>{console.log(JSON.parse(JSON.stringify(E.value)))},G=e=>{window.$dialog.confirm("Delete item?",D("actions.confirm"),{type:"warning"}).then((()=>{n("delete",e)}))};return(e,t)=>{const a=x,n=T;return"system"===r(E).role?(h(),i("div",{key:0,ref_key:"rootRef",ref:R,class:c(["ai-chat-bubble-system",{isEditing:r(H)}]),onClick:t[2]||(t[2]=e=>H.value=!0)},[r(H)?d((h(),i("textarea",{key:0,ref_key:"editInputRef",ref:S,class:"vp-input","onUpdate:modelValue":t[0]||(t[0]=e=>r(E).content=e),rows:"6",onBlur:t[1]||(t[1]=e=>H.value=!1)},null,544)),[[u,r(E).content]]):r(E).content?(h(),i("div",{key:1,class:c(["chat-content",{"markdown-body-dark":e.isDark}]),innerHTML:`[${r(E).role}] ${r(E).content}`},null,10,me)):g("",!0)],2)):(h(),i("div",{key:1,ref_key:"rootRef",ref:R,class:c(["ai-chat-bubble",{"no-avatar-image":!r(P),"is-reply":r(U),"is-editing":r(H)}])},[p("div",he,[p("div",ve,[p("div",{class:"chat-avatar",onClick:q,title:`[${r(E).role}]\n`+(r(A)?`${r(A).name}\n[${r(A).provider}/${r(A).model}]`:"")},[r(A)?(h(),i(b,{key:0},[r(A).avatar?(h(),i("img",{key:0,src:r(A).avatar,alt:r(E).role},null,8,ge)):r(A).name?(h(),i("span",be,f(r(A).name[0]),1)):g("",!0)],64)):(h(),i("span",fe,f(r(E).role),1)),r(A)?(h(),i("span",we,f(r(A).name)+" ["+f(`${r(A).provider}/${r(A).model}`)+"]",1)):g("",!0)],8,ye),p("div",{class:"btn-jump-wrap"},[p("button",{class:"btn-no-style btn-jump",onClick:F},t[9]||(t[9]=[p("span",{class:"mdi mdi-chevron-up"},null,-1)])),p("button",{class:"btn-no-style btn-jump",onClick:O},t[10]||(t[10]=[p("span",{class:"mdi mdi-chevron-down"},null,-1)]))])])]),p("div",{class:c(["chat-body",{isEditing:r(H)}])},[w(C,{name:"fade"},{default:k((()=>[e.isLoading?(h(),i("div",{key:0,class:c(["chat-content markdown-body vp-bg",{"markdown-body-dark":e.isDark}])},[d(p("div",ke,null,512),[[n,!0]])],2)):"string"==typeof r(E).content?(h(),o(pe,{key:1,text:r(E).content,"onUpdate:text":t[3]||(t[3]=e=>r(E).content=e),"is-dark":e.isDark,"is-editing":r(H)},null,8,["text","is-dark","is-editing"])):Array.isArray(r(E).content)?(h(),i(b,{key:2},[(h(!0),i(b,null,_(r(E).content,((t,a)=>(h(),i(b,{key:a},["text"===t.type?d((h(),o(pe,{key:0,text:t.text,"onUpdate:text":e=>t.text=e,"is-dark":e.isDark,"is-editing":r(H)},null,8,["text","onUpdate:text","is-dark","is-editing"])),[[j,r(H)||!!t.text]]):g("",!0)],64)))),128)),r(N).length?(h(),i("div",_e,[(h(!0),i(b,null,_(r(N),((e,t)=>(h(),o(a,{key:t,src:e.url,alt:e.detail,"preview-src-list":r(L),"initial-index":t,"preview-teleported":!0,fit:"contain"},null,8,["src","alt","preview-src-list","initial-index"])))),128))])):g("",!0)],64)):g("",!0)])),_:1}),p("div",je,[r(E).timestamp?(h(),i("div",xe,f(r($)(r(E).timestamp)),1)):g("",!0),r(H)?(h(),i("button",{key:1,class:"btn-no-style",onClick:t[4]||(t[4]=e=>H.value=!1)},[t[11]||(t[11]=p("span",{class:"mdi mdi-check"},null,-1)),I(" "+f(r(D)("actions.done")),1)])):(h(),i(b,{key:2},[p("button",{class:"btn-no-style",onClick:t[5]||(t[5]=e=>r(W)(r(E).content))},[t[12]||(t[12]=p("span",{class:"mdi mdi-content-copy"},null,-1)),I(" "+f(r(D)("actions.copy")),1)]),p("button",{class:"btn-no-style",onClick:t[6]||(t[6]=e=>{return t=r(E).content,void window.$mcUtils.handleExportFile("",t,"_chat.md");var t})},[t[13]||(t[13]=p("span",{class:"mdi mdi-download"},null,-1)),I(" "+f(r(D)("actions.download")),1)]),e.allowRetry?(h(),i("button",{key:0,class:"btn-no-style",onClick:t[7]||(t[7]=t=>e.$emit("retry"))},[t[14]||(t[14]=p("span",{class:"mdi mdi-refresh"},null,-1)),I(" "+f(r(D)("actions.retry")),1)])):g("",!0),e.allowEdit?(h(),i("button",{key:1,class:"btn-no-style",onClick:t[8]||(t[8]=e=>H.value=!0)},[t[15]||(t[15]=p("span",{class:"mdi mdi-pencil"},null,-1)),I(" "+f(r(D)("actions.edit")),1)])):g("",!0),e.allowDelete?(h(),i("button",{key:2,class:"btn-no-style",onClick:G},[t[16]||(t[16]=p("span",{class:"mdi mdi-delete-forever"},null,-1)),I(" "+f(r(D)("actions.delete")),1)])):g("",!0)],64))])],2)],2))}}}),[["__scopeId","data-v-691a6a8e"]]),$e=(e,t)=>{const a=new Map(e.map((e=>[e.id,e])));return t.forEach((e=>{a.set(e.id,e)})),Array.from(a.values()).map(D)},Ie=A((()=>{const{data:e,isFinished:t}=ie(H.PAGE_CRAFT_AI_CHARACTERS,[]),{data:a,isFinished:n}=ie(H.PAGE_CRAFT_AI_HISTORY_GROUP,[]);return{characterList:e,allChatHistory:a,isCharacterListFinished:t,isAllChatHistory:n}})),Te=()=>{const e=Z(),{characterList:t,allChatHistory:a,isCharacterListFinished:n,isAllChatHistory:l}=Ie(),s=async()=>{const e=await fetch("./resources/ai-preset-characters.json");return await e.json()},i=y((()=>t.value.find((t=>t.id===e.currentCharacterId)))),o=y((()=>a.value.length&&i.value?a.value.filter((e=>e.cid===i.value.id)).reverse():[])),r=y((()=>{if(o.value.length)return o.value.find((t=>t.id===e.currentChatHistoryId))}));return{getPresetCharacters:s,updatePresetCharacters:async()=>{t.value=$e(t.value,await s()),window.$message.success({message:"Preset characters updated!"})},characterList:t,allChatHistory:a,isCharacterListFinished:n,isAllChatHistory:l,currentCharacter:i,currentHistoryGroup:o,currentHistory:r}},Ee={class:"image-picker"},Ae=["disabled"],De={class:"image-list"},He=["onClick"],Se=E(t({__name:"ImagePicker",props:{images:{},disabled:{type:Boolean,default:!1}},emits:["update:images"],setup(e,{emit:t}){const a=n(e,"images",t),l=async()=>{try{const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image files",accept:{"image/*":[".png",".jpg",".jpeg",".gif",".webp"]}}]});for(const t of e){const e=await t.getFile();if(e.size<=5242880){const t=new FileReader;t.onload=e=>{e.target&&a.value.push(e.target.result)},t.readAsDataURL(e)}else window.$message.warning(`File ${e.name} is larger than 5MB and has been ignored.`)}}catch(e){console.error("Error picking files: ",e)}};return(e,t)=>{const n=x;return h(),i("div",Ee,[p("button",{class:"vp-button",disabled:e.disabled,onClick:l,title:"Upload image..."},t[0]||(t[0]=[p("span",{class:"mdi mdi-image"},null,-1)]),8,Ae),p("div",De,[(h(!0),i(b,null,_(e.images,((t,l)=>(h(),i("div",{key:l,class:"image-item vp-panel"},[w(n,{"preview-src-list":e.images,"initial-index":l,src:t,"preview-teleported":!0,fit:"contain"},null,8,["preview-src-list","initial-index","src"]),p("button",{onClick:e=>(e=>{a.value.splice(e,1)})(l),class:"btn-no-style",title:"Remove"},"✖",8,He)])))),128))])])}}}),[["__scopeId","data-v-2c943614"]]),Ue=async(e,t)=>{let a="";a+=`<!doctype html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport"\n        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">\n  <meta http-equiv="X-UA-Compatible" content="ie=edge">\n  <title>${t}</title>`;return a+=`<style>body { font-family: Arial, sans-serif; }\n* {box-sizing: border-box;}\n${(await S((()=>import("./github-markdown-C1Tk3yIV.js")),[],import.meta.url)).default}\n${(await S((()=>Promise.resolve().then((()=>Re))),void 0,import.meta.url)).default}\n.ai-chat-bubble-system {\n    margin-bottom: 10px;\n    padding: 10px;\n    border: 1px solid #dddddd;\n    font-size: 12px;\n    color: #8a8a8a;\n}\n.btn-jump-wrap {\n    display: none;\n}\n.chat-actions button {\n    display: none;\n}\n.chat-date {\n    margin-top: 10px;\n    opacity: .5;\n}\n.chat-header {\n    margin: -10px -10px 10px;\n    padding: 4px 10px;\n    background-color: #F6F8FA;\n}\n.chat-avatar {\n    display: flex;\n    align-items: center;\n    height: 32px;\n    gap: 10px;\n}\n.chat-avatar img {\n    width: 32px;\n    height: 32px;\n}\n.chat-username {\n    font-weight: bold;\n}\n.ai-chat-bubble {\n    border: 1px solid #dddddd;\n    margin: 10px 0;\n    padding: 10px;\n}\n._js-action-button {\n    display: none;\n}\npre.hljs-code-container {\n    padding: 0;\n}\n.hljs-code-header {\n    padding: 2px 10px;\n    opacity: .5;\n}\n.markdown-body pre > code {\n    white-space: pre-wrap;\n    padding: 10px;\n}\nimg {\n    max-width: 100%;\n}\n</style>`,a+="</head><body>",a+=e.innerHTML,a+="</body></html>",a},Pe="pre code.hljs {\n  display: block;\n  overflow-x: auto;\n  padding: 1em\n}\ncode.hljs {\n  padding: 3px 5px\n}\n/*!\n  Theme: GitHub\n  Description: Light theme as seen on github.com\n  Author: github.com\n  Maintainer: @Hirse\n  Updated: 2021-05-15\n\n  Outdated base version: https://github.com/primer/github-syntax-light\n  Current colors taken from GitHub's CSS\n*/\n.hljs {\n  color: #24292e;\n  background: #ffffff\n}\n.hljs-doctag,\n.hljs-keyword,\n.hljs-meta .hljs-keyword,\n.hljs-template-tag,\n.hljs-template-variable,\n.hljs-type,\n.hljs-variable.language_ {\n  /* prettylights-syntax-keyword */\n  color: #d73a49\n}\n.hljs-title,\n.hljs-title.class_,\n.hljs-title.class_.inherited__,\n.hljs-title.function_ {\n  /* prettylights-syntax-entity */\n  color: #6f42c1\n}\n.hljs-attr,\n.hljs-attribute,\n.hljs-literal,\n.hljs-meta,\n.hljs-number,\n.hljs-operator,\n.hljs-variable,\n.hljs-selector-attr,\n.hljs-selector-class,\n.hljs-selector-id {\n  /* prettylights-syntax-constant */\n  color: #005cc5\n}\n.hljs-regexp,\n.hljs-string,\n.hljs-meta .hljs-string {\n  /* prettylights-syntax-string */\n  color: #032f62\n}\n.hljs-built_in,\n.hljs-symbol {\n  /* prettylights-syntax-variable */\n  color: #e36209\n}\n.hljs-comment,\n.hljs-code,\n.hljs-formula {\n  /* prettylights-syntax-comment */\n  color: #6a737d\n}\n.hljs-name,\n.hljs-quote,\n.hljs-selector-tag,\n.hljs-selector-pseudo {\n  /* prettylights-syntax-entity-tag */\n  color: #22863a\n}\n.hljs-subst {\n  /* prettylights-syntax-storage-modifier-import */\n  color: #24292e\n}\n.hljs-section {\n  /* prettylights-syntax-markup-heading */\n  color: #005cc5;\n  font-weight: bold\n}\n.hljs-bullet {\n  /* prettylights-syntax-markup-list */\n  color: #735c0f\n}\n.hljs-emphasis {\n  /* prettylights-syntax-markup-italic */\n  color: #24292e;\n  font-style: italic\n}\n.hljs-strong {\n  /* prettylights-syntax-markup-bold */\n  color: #24292e;\n  font-weight: bold\n}\n.hljs-addition {\n  /* prettylights-syntax-markup-inserted */\n  color: #22863a;\n  background-color: #f0fff4\n}\n.hljs-deletion {\n  /* prettylights-syntax-markup-deleted */\n  color: #b31d28;\n  background-color: #ffeef0\n}\n.hljs-char.escape_,\n.hljs-link,\n.hljs-params,\n.hljs-property,\n.hljs-punctuation,\n.hljs-tag {\n  /* purposely ignored */\n  \n}",Re=Object.freeze(Object.defineProperty({__proto__:null,default:Pe},Symbol.toStringTag,{value:"Module"})),Fe={key:0,class:"chat-gpt-wrap vp-bg"},Oe={class:"request-below"},Ne=["placeholder"],Le={class:"request-actions"},qe={class:"action-side"},Ge=["disabled"],Je={class:"action-side"},Me=["disabled"],Be=E(t({__name:"ChatContent",setup(e){const{t:t}=v(),a=U(),n=Z(),{currentCharacter:c,currentHistory:j}=Te(),{css:x}=P("",{id:"element-style-override"});s((()=>a.isAppDarkMode),(e=>{x.value=e?"pre code.hljs {\n  display: block;\n  overflow-x: auto;\n  padding: 1em\n}\ncode.hljs {\n  padding: 3px 5px\n}\n/*!\n  Theme: GitHub Dark\n  Description: Dark theme as seen on github.com\n  Author: github.com\n  Maintainer: @Hirse\n  Updated: 2021-05-15\n\n  Outdated base version: https://github.com/primer/github-syntax-dark\n  Current colors taken from GitHub's CSS\n*/\n.hljs {\n  color: #c9d1d9;\n  background: #0d1117\n}\n.hljs-doctag,\n.hljs-keyword,\n.hljs-meta .hljs-keyword,\n.hljs-template-tag,\n.hljs-template-variable,\n.hljs-type,\n.hljs-variable.language_ {\n  /* prettylights-syntax-keyword */\n  color: #ff7b72\n}\n.hljs-title,\n.hljs-title.class_,\n.hljs-title.class_.inherited__,\n.hljs-title.function_ {\n  /* prettylights-syntax-entity */\n  color: #d2a8ff\n}\n.hljs-attr,\n.hljs-attribute,\n.hljs-literal,\n.hljs-meta,\n.hljs-number,\n.hljs-operator,\n.hljs-variable,\n.hljs-selector-attr,\n.hljs-selector-class,\n.hljs-selector-id {\n  /* prettylights-syntax-constant */\n  color: #79c0ff\n}\n.hljs-regexp,\n.hljs-string,\n.hljs-meta .hljs-string {\n  /* prettylights-syntax-string */\n  color: #a5d6ff\n}\n.hljs-built_in,\n.hljs-symbol {\n  /* prettylights-syntax-variable */\n  color: #ffa657\n}\n.hljs-comment,\n.hljs-code,\n.hljs-formula {\n  /* prettylights-syntax-comment */\n  color: #8b949e\n}\n.hljs-name,\n.hljs-quote,\n.hljs-selector-tag,\n.hljs-selector-pseudo {\n  /* prettylights-syntax-entity-tag */\n  color: #7ee787\n}\n.hljs-subst {\n  /* prettylights-syntax-storage-modifier-import */\n  color: #c9d1d9\n}\n.hljs-section {\n  /* prettylights-syntax-markup-heading */\n  color: #1f6feb;\n  font-weight: bold\n}\n.hljs-bullet {\n  /* prettylights-syntax-markup-list */\n  color: #f2cc60\n}\n.hljs-emphasis {\n  /* prettylights-syntax-markup-italic */\n  color: #c9d1d9;\n  font-style: italic\n}\n.hljs-strong {\n  /* prettylights-syntax-markup-bold */\n  color: #c9d1d9;\n  font-weight: bold\n}\n.hljs-addition {\n  /* prettylights-syntax-markup-inserted */\n  color: #aff5b4;\n  background-color: #033a16\n}\n.hljs-deletion {\n  /* prettylights-syntax-markup-deleted */\n  color: #ffdcd7;\n  background-color: #67060c\n}\n.hljs-char.escape_,\n.hljs-link,\n.hljs-params,\n.hljs-property,\n.hljs-punctuation,\n.hljs-tag {\n  /* purposely ignored */\n  \n}":Pe}),{immediate:!0});const C=l(!1),$=l(""),T=l(null),E=()=>({role:"system",content:c.value.systemPrompt,timestamp:Date.now()}),A=()=>{c.value&&j.value&&(j.value.history=[E()],T.value=null)},D=l(),H=l(),S=({behavior:e="smooth"}={})=>{D.value&&setTimeout((()=>{const t=D.value;t.scrollTo({top:t.scrollHeight,behavior:e})}))},z=()=>{setTimeout((()=>{var e;null==(e=H.value)||e.focus()}))};R(F.ON_AI_CHARACTER_UPDATE,(()=>{j.value&&(j.value.history.shift(),j.value.history.unshift(E()))}));const{requestChatStream:K,requestChatMessage:Q}=ee(),W=y((()=>{var e;return!1!==te[null==(e=c.value)?void 0:e.model]})),X=l([]),Y=y((()=>!(!c.value||!j.value)&&(!C.value&&!(!$.value&&!X.value.length)))),ne=O(null),le=async(e=!1)=>{if(e);else if(!Y.value)return;try{if(S({behavior:"auto"}),C.value=!0,T.value={role:"assistant",content:""},!e){let e;e=W&&X.value.length?[{text:$.value,type:"text"},...X.value.map((e=>({type:"image_url",image_url:{detail:"auto",url:e}})))]:$.value,j.value.history.push({role:"user",content:e,timestamp:Date.now()}),$.value="",X.value=[]}if(!D.value)throw new Error("respContainerRef.value is null");const t=D.value;let a=0,l=t.scrollTop>0;console.log("containerEl",t,t.scrollTop,l),setTimeout((()=>{a=t.scrollTop+t.offsetHeight*(2/3)}));let s=1;const i=()=>{l&&(t.scrollTop>=a?l=!1:(t.scrollTo({top:a,behavior:"smooth"}),s++))},o=new AbortController,{signal:r}=o;ne.value=o;const d=c.value.provider||ae.OPEN_AI,u=c.value.model,p=j.value.history.map((e=>({content:e.content,role:e.role})));if(n.stream){await K(d,u,p,(e=>{T.value.content+=e,i()}),{signal:r});const e=T.value;T.value=null,e.timestamp=Date.now(),j.value.history.push(e)}else{const e=await Q({provider:d,model:u,messages:p});T.value=null,j.value.history.push({role:"assistant",content:e||"",timestamp:Date.now()})}(async()=>{if(j.value&&j.value.history.length&&!j.value.title)try{const e=[...j.value.history];e.shift(),j.value.title=await Q({provider:n.provider,model:n.model,messages:oe(e)})}catch(e){console.error(e)}})()}catch(t){if(ne.value){const{signal:e}=ne.value;if(e.aborted)return void window.$message.warning("Fetch request was aborted")}console.error(t),T.value={role:"assistant",content:t.message,timestamp:Date.now()}}finally{C.value=!1,ne.value=null,z()}},se=e=>{"Enter"===e.key&&(n.isEnterSend?e.shiftKey||(e.preventDefault(),le()):e.ctrlKey&&(e.preventDefault(),le()))},ie=e=>{if(!W.value)return;const t=e.clipboardData;console.log("clipboardData",t);const a=t.items;for(let n=0;n<a.length;n++){const e=a[n];if(/^image/i.test(e.type)){const t=e.getAsFile(),a=new FileReader;a.onload=function(e){const t=e.target.result;t&&X.value.push(t)},a.readAsDataURL(t)}}},re=()=>{ne.value&&(ne.value.abort(),n.stream||(T.value=null))};N((()=>{re()})),s(j,(()=>{re(),j.value&&(j.value.history.length||A(),T.value=null,setTimeout((()=>{z(),S({behavior:"auto"})})))}),{immediate:!0});const ce=async()=>{var e;await(async(e,t="")=>{const a=document.createElement("iframe");a.style.position="absolute",a.style.width="0",a.style.height="0",a.style.border="none",document.body.appendChild(a);const n=a.contentWindow,l=n.document;l.open(),l.write(await Ue(e,t)),l.close(),setTimeout((()=>{const e=document.title;document.title=t,n.print(),document.body.removeChild(a),document.title=e}),500)})(D.value,(null==(e=j.value)?void 0:e.title)||"Chat")},de=l([{label:"Print to PDF...",iconClass:"mdi mdi-printer",props:{onClick(){ce()}}},{label:"Save HTML file",iconClass:"mdi mdi-language-html5",props:{onClick(){(async()=>{var e;const t=(null==(e=j.value)?void 0:e.title)||"Chat";window.$mcUtils.handleExportFile(t,await Ue(D.value,t),".html")})()}}},{split:!0},{label:"Import JSON",iconClass:"mdi mdi-import",props:{async onClick(){j.value.history=await window.$mcUtils.handleImportJson(),window.$message.success(t("msgs.import_success"))}}},{label:"Export JSON",iconClass:"mdi mdi-export",props:{async onClick(){var e;window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName(null,(null==(e=j.value)?void 0:e.title)||"Chat"),JSON.stringify(j.value.history,null,2),".json")}}}]),ue=()=>{B.emit(F.OPEN_SETTINGS,V.AI)};return(e,l)=>{const s=J,v=M;return h(),o(L,{name:"fade",mode:"in-out"},{default:k((()=>[r(j)&&r(c)?(h(),i("div",Fe,[p("div",{ref_key:"respContainerRef",ref:D,class:"response-container"},[(h(!0),i(b,null,_(r(j).history,((e,t)=>(h(),o(Ce,{key:e.timestamp,item:e,"is-dark":r(a).isAppDarkMode,onDelete:e=>r(j).history.splice(t,1),onRetry:a=>((e,t)=>{j.value&&("assistant"===e.role&&j.value.history.splice(t,1),le(!0))})(e,t),"allow-delete":"","allow-edit":"","allow-retry":t===r(j).history.length-1,character:"assistant"===e.role?r(c):void 0},null,8,["item","is-dark","onDelete","onRetry","allow-retry","character"])))),128)),r(T)?(h(),o(Ce,{key:0,item:r(T),"is-dark":r(a).isAppDarkMode,character:r(c),"is-loading":!r(T).content},null,8,["item","is-dark","character","is-loading"])):g("",!0)],512),p("div",Oe,[d(p("textarea",{ref_key:"inputRef",ref:H,class:"vp-input question-input","onUpdate:modelValue":l[0]||(l[0]=e=>m($)?$.value=e:null),type:"textarea",placeholder:r(n).isEnterSend?r(t)("ai.enter_send_tips_1"):r(t)("ai.enter_send_tips_2"),onKeydown:se,onPaste:ie},null,40,Ne),[[u,r($)]]),p("div",Le,[p("div",qe,[p("button",{class:"vp-button",title:"Settings",onClick:ue},l[5]||(l[5]=[p("span",{class:"mdi mdi-cog"},null,-1)])),w(q,{options:r(de)},{default:k((()=>l[6]||(l[6]=[p("button",{class:"vp-button",title:"Export"},[p("span",{class:"mdi mdi-tray-arrow-down"})],-1)]))),_:1},8,["options"]),p("button",{onClick:l[1]||(l[1]=e=>S()),onContextmenu:l[2]||(l[2]=G((e=>{D.value&&setTimeout((()=>{D.value.scrollTo({top:0,behavior:"smooth"})}))}),["prevent"])),class:"vp-button",title:"Scroll to bottom, right click scroll to top"},l[7]||(l[7]=[p("span",{class:"mdi mdi-unfold-more-horizontal"},null,-1)]),32),w(s,{onConfirm:A,title:"Confirm clear chat history?",teleported:!1},{reference:k((()=>[p("button",{class:"vp-button",disabled:r(C)},f(r(t)("actions.clear")),9,Ge)])),_:1})]),p("div",Je,[w(v,null,{default:k((()=>[I(f(r(c).model),1)])),_:1}),w(Se,{images:r(X),"onUpdate:images":l[3]||(l[3]=e=>m(X)?X.value=e:null),disabled:r(C)||!r(W)},null,8,["images","disabled"]),r(C)?(h(),i("button",{key:0,class:"vp-button",onClick:re},[l[8]||(l[8]=p("span",{class:"mdi mdi-stop-circle-outline"},null,-1)),I(" "+f(r(t)("ai.stop_generation")),1)])):(h(),i("button",{key:1,class:"vp-button primary",disabled:!r(Y),onClick:l[4]||(l[4]=e=>le())},[l[9]||(l[9]=p("span",{class:"mdi mdi-send"},null,-1)),I(" "+f(r(t)("actions.send")),1)],8,Me))])])])])):g("",!0)])),_:1})}}}),[["__scopeId","data-v-abc44d27"]]),Ve=({index:e,cb:t})=>{const a=e=>e.target.closest(".sub-item");return{draggable:!0,onDragstart:t=>{a(t),t.dataTransfer.setData("data-transfer-index",e)},onDragover:e=>{e.preventDefault();a(e).classList.add("_drag-over")},onDragleave:e=>{e.preventDefault();a(e).classList.remove("_drag-over")},onDrop:n=>{n.preventDefault();a(n).classList.remove("_drag-over");const l=Number(n.dataTransfer.getData("data-transfer-index"));t(l,e,n)}}},ze={class:"ai-side-characters"},Ke=t({__name:"SideCharacters",setup(e){const{t:t}=v(),a=Z(),{characterList:n,allChatHistory:o,updatePresetCharacters:c,isCharacterListFinished:d}=Te(),u=l(!1),p=l(!1),m=(e={})=>({id:e.id||"",name:e.name||"",desc:e.desc||"",avatar:e.avatar||"",provider:e.provider||ae.OPEN_AI,model:e.model||se,systemPrompt:e.systemPrompt||""}),g=l(m()),b=(e,t)=>{const a=[...n.value];if(e<0||e>=a.length||t<0||t>=a.length||e===t)return;const[l]=a.splice(e,1),s=e<t?t-1:t;a.splice(s,0,l),n.value=a.map(D)},f=y((()=>[{label:t("ai.characters"),key:"characters",hideExpandIcon:!0,actionRender:()=>de([{label:`➕ ${t("actions.create")}`,props:{onClick:()=>{u.value=!0,g.value=m(),p.value=!0}}},{label:`📤 ${t("actions.export")} JSON...`,props:{onClick:async()=>{window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName("AICharacters"),JSON.stringify(n.value,null,2),".json")}}},{label:`📥 ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();n.value=$e(n.value,e||[]),window.$message.success("Import success!")}}},{label:`🗑️ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci")+" !!All chat records will be deleted!!",t("actions.delete_all"),{type:"warning"}).then((()=>{n.value=[],o.value=[]})).catch()}}},{label:t("ai.geng_xin_yu_she_jue"),iconClass:"mdi mdi-shape-plus-outline",props:{onClick:()=>{c()}}}]),children:n.value.map(((e,l)=>({key:e.id,label:`${e.name}`,subtitle:`${e.desc} [${e.model}]`,icon:e.avatar,iconClass:"mdi mdi-account-circle-outline",cls:a.currentCharacterId===e.id?"active":"",clickFn:()=>{a.currentCharacterId=e.id},itemProps:Ve({index:l,cb:b}),actionRender:()=>de([{label:`✏️ ${t("actions.edit")}`,props:{onClick:()=>{u.value=!1,g.value=m(e),p.value=!0}}},{label:`📄 ${t("actions.duplicate")}...`,props:{onClick:async()=>{u.value=!0,g.value=m(e),p.value=!0}}},{label:`🗑️ ${t("actions.delete")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci")+" !!Chat records will be deleted!!",t("actions.confirm"),{type:"warning"}).then((()=>{o.value=o.value.filter((t=>t.cid!==e.id)).map(D),n.value.splice(l,1)})).catch()}}}])})))}]));s(d,(e=>{e&&(n.value.length||c(),setTimeout((()=>{document.querySelectorAll(".ai-option-ui .sub-item.active").forEach((e=>{e.scrollIntoView({behavior:"smooth",block:"center"})}))}),600))}));const _=l({id:{required:!0,trigger:"blur",validator:(e,t)=>{if(!t)return new Error("id is required");if(u.value){if(n.value.findIndex((e=>e.id===t))>-1)return new Error("id can not be same")}return!0}},provider:{required:!0,trigger:"blur"},model:{required:!0,trigger:"blur"},name:{required:!0,trigger:"blur"}}),j=y((()=>{const e=ne(g.value.provider),a=g.value.provider===ae.OPEN_AI_COMPATIBLE;return[[{type:ce.INPUT,key:"name",label:t("ai.name"),props:{onChange:()=>{if(u.value){const e=g.value.name.trim();g.value.name=e,!g.value.id&&e&&(g.value.id=window.$mcUtils.formatI18nKey(e))}}}},{type:ce.INPUT,key:"avatar",label:`${t("ai.avatar")} URL`,props:{clearable:!0},render:()=>z("button",{type:"button",class:"btn-no-style mdi mdi-image-plus",onClick:async()=>{const e=await X.chooseFileToBase64({accept:"image/*"});"string"==typeof e&&(g.value.avatar=e)}})}],[{type:ce.INPUT,key:"id",label:`ID (${t("ai.chuang_jian_hou_bu_k")})`,disabled:!u.value},{type:ce.INPUT,key:"desc",label:t("common.bei_zhu"),placeholder:""}],[{type:ce.SELECT,options:le,key:"provider",label:t("ai.ti_gong_shang"),props:{filterable:!0,onChange(){g.value.model=ne(g.value.provider)[0].value}}},{type:ce.SELECT,options:e,key:"model",label:t("ai.model")+` ${g.value.model}`,props:{allowCreate:!0,filterable:!0},render:a?()=>z("button",{type:"button",class:"btn-no-style mdi mdi-help-circle-outline",onClick:()=>{window.open("https://aihubmix.com/models","_blank","noopener,noreferrer")}}):null}],{type:ce.INPUT,key:"systemPrompt",label:t("ai.system_prompt"),props:{type:"textarea",rows:8}}]})),x=()=>{if(p.value=!1,u.value)return void n.value.push(g.value);const e=n.value.findIndex((e=>e.id===g.value.id));e>-1&&n.value.splice(e,1,g.value),B.emit(F.ON_AI_CHARACTER_UPDATE)};return(e,a)=>{const n=K;return h(),i("div",ze,[w(re,{class:"ai-option-ui","option-list":f.value},null,8,["option-list"]),w(n,{draggable:"",top:"10vh",width:"700",modelValue:p.value,"onUpdate:modelValue":a[0]||(a[0]=e=>p.value=e),title:u.value?r(t)("actions.create"):r(t)("actions.edit")},{default:k((()=>[w(ue,{"form-schema":{model:g.value,rules:_.value,props:{labelPosition:"top"},formItems:j.value},onOnSubmit:x},null,8,["form-schema"])])),_:1},8,["modelValue","title"])])}}}),Qe={class:"ai-side-history"},We=t({__name:"SideHistory",setup(e){const{t:t}=v(),a=Z(),{currentCharacter:n,allChatHistory:l,isCharacterListFinished:o,isAllChatHistory:c,currentHistoryGroup:d,currentHistory:u}=Te(),p=()=>{if(!n.value)return;console.log("[isCharacterListFinished]",o.value),console.log("[isAllChatHistory]",c.value);const e=Q(),t={id:e,cid:n.value.id,title:"",timestamp:Date.now(),history:[]};l.value.push(t),a.currentChatHistoryId=e};s(n,(e=>{o.value&&c.value&&m()})),s(c,(e=>{e&&m()}));const m=()=>{setTimeout((()=>{n.value&&!d.value.length&&p(),!u.value&&d.value.length&&(a.currentChatHistoryId=d.value[0].id)}))},g=y((()=>{if(!n.value)return[];const e=t("ai.yu_current_character",[n.value.name]),s=()=>{l.value=l.value.filter((e=>e.cid!==n.value.id)).map(D)};return[{label:e,key:"history",hideExpandIcon:!0,actionRender:()=>de([{label:`📤 ${t("actions.export")} JSON...`,props:{onClick:async()=>{const t=l.value.filter((e=>e.cid===n.value.id));window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName(e),JSON.stringify(t,null,2),".json")}}},{label:`📥 ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();l.value=e||[];const t=l.value.filter((e=>e.cid===n.value.id)),a=$e(t,e);s(),l.value=a,window.$message.success("Import success!")}}},{label:`🗑️ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.delete_all"),{type:"warning"}).then((()=>{s()})).catch()}}}]),children:[{label:`${t("ai.new_chat")}`,iconClass:"mdi mdi-plus",clickFn:()=>{p()}},...d.value.map(((n,s)=>({key:n.id,label:n.title||e,subtitle:$(n.timestamp),cls:a.currentChatHistoryId===n.id?"active":"",clickFn:()=>{a.currentChatHistoryId=n.id},actionRender:()=>de([{label:`✍️ ${t("actions.rename")}`,props:{onClick:async()=>{const e=await window.$mcUtils.showInputPrompt({title:`${t("actions.rename")}: ${n.title}`,value:n.title});n.title=e}}},{label:`🗑️ ${t("actions.delete")}`,props:{onClick:()=>{const e=l.value.findIndex((e=>e.id===n.id));e>-1&&l.value.splice(e,1)}}}])})))]}]}));return(e,t)=>(h(),i("div",Qe,[w(re,{class:"ai-option-ui","option-list":r(g)},null,8,["option-list"])]))}}),Xe={class:"ai-chat-root vp-panel"},Ye={key:0,class:"mdi mdi-chevron-right"},Ze={key:1,class:"mdi mdi-chevron-left"},et=t({__name:"ChatRoot",setup(e){const t=Z();return(e,a)=>(h(),i("div",Xe,[p("div",{class:c(["chat-sidebar",{_expand:r(t).isSidebarExpand}])},[w(Ke),w(We),p("button",{class:"btn-toggle-expand btn-no-style",onClick:a[0]||(a[0]=e=>r(t).isSidebarExpand=!r(t).isSidebarExpand)},[r(t).isSidebarExpand?(h(),i("span",Ze)):(h(),i("span",Ye))])],2),w(Be)]))}}),tt={class:"ai-page scrollbar-mini"},at=E(t({__name:"AiPage",setup:t=>(t,a)=>(h(),i("div",tt,[w(e),w(et)]))}),[["__scopeId","data-v-003ae9b4"]]);export{at as default};
