import{d as e,t,U as a,x as s,o as l,b as i,k as n,v as o,e as r,X as c,h as d,p as u,D as p,r as m,K as v,c as h,g as y,f as g,P as b,M as f,F as w,m as A,aA as k,bN as _,bO as C,Z as x,$ as E,a0 as I,_ as B,bP as D,aN as T,bQ as R,ah as H,u as $,s as P,af as L,N as U,J as j,V as S,w as F,Q as N,T as O,G as Q,ay as M,ad as q,bR as V,y as J,S as z,a5 as K}from"./index-Dcsrw7an.js";/* empty css                  *//* empty css                      *//* empty css                   *//* empty css                   */import{c as G,b as Y}from"./base64-utils-t9Z9IyMS.js";import{f as W,g as X}from"./index-BSUZN_B5.js";import{_ as Z}from"./MarkdownRender.vue_vue_type_script_setup_true_lang-DujZSKAj.js";import{a as ee,A as te,d as ae,b as se,u as le,m as ie,g as ne,c as oe}from"./use-common-ai-BUoKJvYz.js";import{u as re}from"./useIDBKeyval-DAptoUO-.js";import{a as ce}from"./prompts-Deq7hQsx.js";import{_ as de}from"./SettingsAi.vue_vue_type_script_setup_true_lang-CKnPlJ2w.js";/* empty css                        */import{_ as ue}from"./index.vue_vue_type_script_setup_true_lang-D-CNzH-9.js";import{A as pe}from"./enum-CdO7LyZZ.js";import{r as me}from"./renders-BPO_BjD1.js";import{_ as ve}from"./index.vue_vue_type_style_index_0_lang-BKM7gDo_.js";const he="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20viewBox='0%200%202406%202406'%3e%3cpath%20d='M1%20578.4C1%20259.5%20259.5%201%20578.4%201h1249.1c319%200%20577.5%20258.5%20577.5%20577.4V2406H578.4C259.5%202406%201%202147.5%201%201828.6V578.4z'%20fill='%2374aa9c'/%3e%3cpath%20id='a'%20d='M1107.3%20299.1c-197.999%200-373.9%20127.3-435.2%20315.3L650%20743.5v427.9c0%2021.4%2011%2040.4%2029.4%2051.4l344.5%20198.515V833.3h.1v-27.9L1372.7%20604c33.715-19.52%2070.44-32.857%20108.47-39.828L1447.6%20450.3C1361%20353.5%201237.1%20298.5%201107.3%20299.1zm0%20117.5-.6.6c79.699%200%20156.3%2027.5%20217.6%2078.4-2.5%201.2-7.4%204.3-11%206.1L952.8%20709.3c-18.4%2010.4-29.4%2030-29.4%2051.4V1248l-155.1-89.4V755.8c-.1-187.099%20151.601-338.9%20339-339.2z'%20fill='%23fff'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(60%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(120%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(180%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(240%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(300%201203%201203)'/%3e%3c/svg%3e",ye=e({__name:"TextContent",props:{isDark:{type:Boolean,default:!1},isEditing:{type:Boolean,default:!1},text:{default:""}},emits:["update:text"],setup(e,{emit:p}){const m=e,{text:v,isEditing:h}=t(m),y=a(m,"text",p);return(e,t)=>s(h)?(l(),i("div",{key:0,class:d(["chat-content vp-bg",{"markdown-body-dark":e.isDark}]),style:{width:"100%"}},[n(r("textarea",{class:"vp-input","onUpdate:modelValue":t[0]||(t[0]=e=>c(y)?y.value=e:null),rows:"10",ref:"editInputRef",style:{width:"100%","font-size":"16px","box-sizing":"border-box"}},null,512),[[o,s(y)]])],2)):(l(),u(Z,{key:1,class:"chat-content vp-bg",dark:e.isDark,text:s(y)},null,8,["dark","text"]))}}),ge=e=>(E("data-v-11d58648"),e=e(),I(),e),be=["innerHTML"],fe={class:"chat-side"},we={class:"chat-header"},Ae=["title"],ke=["src","alt","title"],_e={key:1,class:"chat-username"},Ce={key:2,class:"chat-username _character"},xe=[ge((()=>r("span",{class:"mdi mdi-chevron-up"},null,-1)))],Ee=[ge((()=>r("span",{class:"mdi mdi-chevron-down"},null,-1)))],Ie={style:{width:"50px",height:"50px"},"element-loading-background":"transparent"},Be={key:0,class:"chat-images"},De={class:"chat-actions"},Te={key:0,class:"chat-date font-code"},Re=B(e({__name:"ChatBubble",props:{isDark:{type:Boolean,default:!1},allowDelete:{type:Boolean,default:!1},allowEdit:{type:Boolean},allowRetry:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},character:{},item:{}},emits:["delete","retry"],setup(e,{emit:a}){const c=a,E=e,{item:I}=t(E),{t:B}=p(),D=m(!1),T=m();v(D,(()=>{setTimeout((()=>{T.value&&T.value.focus()}))}));const R=h((()=>"assistant"===I.value.role)),H=m(),$=()=>{const e=H.value;e.parentElement.scrollTo({top:e.offsetTop-10,behavior:"smooth"})},P=()=>{const e=H.value,t=e.parentElement;t.scrollTo({top:e.offsetTop+e.offsetHeight-t.offsetHeight+10,behavior:"smooth"})},L=h((()=>{if(!I.value)return[];if(Array.isArray(I.value.content)){const e=I.value.content,t=[];return e.forEach((e=>{const{type:a,image_url:s}=e;"image_url"===a&&t.push(s)})),t}return[]})),U=h((()=>L.value.map((e=>e.url)))),j=()=>{console.log(JSON.parse(JSON.stringify(I.value)))},S=e=>{window.$dialog.confirm("Delete item?",B("actions.confirm"),{type:"warning"}).then((()=>{c("delete",e)}))};return(e,t)=>{const a=C,c=x;return"system"===s(I).role?(l(),i("div",{key:0,ref_key:"rootRef",ref:H,class:d(["ai-chat-bubble-system",{isEditing:s(D)}]),onClick:t[2]||(t[2]=e=>D.value=!0)},[s(D)?n((l(),i("textarea",{key:0,ref_key:"editInputRef",ref:T,class:"vp-input","onUpdate:modelValue":t[0]||(t[0]=e=>s(I).content=e),rows:"6",onBlur:t[1]||(t[1]=e=>D.value=!1)},null,544)),[[o,s(I).content]]):s(I).content?(l(),i("div",{key:1,class:d(["chat-content",{"markdown-body-dark":e.isDark}]),innerHTML:`[${s(I).role}] ${s(I).content}`},null,10,be)):y("",!0)],2)):(l(),i("div",{key:1,ref_key:"rootRef",ref:H,class:d(["ai-chat-bubble",{isReply:s(R),isEditing:s(D)}])},[r("div",fe,[r("div",we,[r("div",{class:"chat-avatar",title:s(I).role,onClick:j},[e.character?(l(),i("img",{key:0,src:e.character.avatar||s(he),alt:s(I).role,title:`${e.character.name}\n[${e.character.provider}/${e.character.model}]`},null,8,ke)):(l(),i("span",_e,g(s(I).role),1)),e.character?(l(),i("span",Ce,g(e.character.name)+" ["+g(`${e.character.provider}/${e.character.model}`)+"]",1)):y("",!0)],8,Ae),r("div",{class:"btn-jump-wrap"},[r("button",{class:"btn-no-style btn-jump",onClick:$},xe),r("button",{class:"btn-no-style btn-jump",onClick:P},Ee)])])]),r("div",{class:d(["chat-body",{isEditing:s(D)}])},[b(_,{name:"fade"},{default:f((()=>[e.isLoading?(l(),i("div",{key:0,class:d(["chat-content markdown-body vp-bg",{"markdown-body-dark":e.isDark}])},[n(r("div",Ie,null,512),[[c,!0]])],2)):"string"==typeof s(I).content?(l(),u(ye,{key:1,text:s(I).content,"onUpdate:text":t[3]||(t[3]=e=>s(I).content=e),"is-dark":e.isDark,"is-editing":s(D)},null,8,["text","is-dark","is-editing"])):Array.isArray(s(I).content)?(l(),i(w,{key:2},[(l(!0),i(w,null,A(s(I).content,((t,a)=>(l(),i(w,{key:a},["text"===t.type?n((l(),u(ye,{key:0,text:t.text,"onUpdate:text":e=>t.text=e,"is-dark":e.isDark,"is-editing":s(D)},null,8,["text","onUpdate:text","is-dark","is-editing"])),[[k,s(D)||!!t.text]]):y("",!0)],64)))),128)),s(L).length?(l(),i("div",Be,[(l(!0),i(w,null,A(s(L),((e,t)=>(l(),u(a,{key:t,src:e.url,alt:e.detail,"preview-src-list":s(U),"initial-index":t,"preview-teleported":!0,fit:"contain"},null,8,["src","alt","preview-src-list","initial-index"])))),128))])):y("",!0)],64)):y("",!0)])),_:1}),r("div",De,[s(I).timestamp?(l(),i("div",Te,g(s(W)(s(I).timestamp)),1)):y("",!0),s(D)?(l(),i("button",{key:1,class:"btn-no-style",onClick:t[4]||(t[4]=e=>D.value=!1)}," âœ… "+g(s(B)("actions.done")),1)):(l(),i(w,{key:2},[r("button",{class:"btn-no-style",onClick:t[5]||(t[5]=e=>s(G)(s(I).content))}," ðŸ“‹ "+g(s(B)("actions.copy")),1),e.allowRetry?(l(),i("button",{key:0,class:"btn-no-style",onClick:t[6]||(t[6]=t=>e.$emit("retry"))}," ðŸ”„ "+g(s(B)("actions.retry")),1)):y("",!0),e.allowEdit?(l(),i("button",{key:1,class:"btn-no-style",onClick:t[7]||(t[7]=e=>D.value=!0)}," ðŸ“ "+g(s(B)("actions.edit")),1)):y("",!0),e.allowDelete?(l(),i("button",{key:2,class:"btn-no-style",onClick:S}," ðŸ—‘ï¸ "+g(s(B)("actions.delete")),1)):y("",!0)],64))])],2)],2))}}}),[["__scopeId","data-v-11d58648"]]),He=(e,t)=>{const a=new Map(e.map((e=>[e.id,e])));return t.forEach((e=>{a.set(e.id,e)})),Array.from(a.values()).map(R)},$e=D((()=>{const{data:e,isFinished:t}=re(T.PAGE_CRAFT_AI_CHARACTERS,[]),{data:a,isFinished:s}=re(T.PAGE_CRAFT_AI_HISTORY_GROUP,[]);return{characterList:e,allChatHistory:a,isCharacterListFinished:t,isAllChatHistory:s}})),Pe=()=>{const e=ee(),{characterList:t,allChatHistory:a,isCharacterListFinished:s,isAllChatHistory:l}=$e(),i=()=>[{id:"default",name:"ChatGPT",desc:"",avatar:he,provider:te.OPEN_AI,model:ae,systemPrompt:"You are a helpful assistant."},{id:"claude",name:"Claude AI",desc:"",avatar:"data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20width='46'%20height='32'%20viewBox='0%200%2046%2032'%3e%3cpath%20d='M32.73%200h-6.945L38.45%2032h6.945L32.73%200ZM12.665%200%200%2032h7.082l2.59-6.72h13.25l2.59%206.72h7.082L19.929%200h-7.264Zm-.702%2019.337%204.334-11.246%204.334%2011.246h-8.668Z'%20fill='currentColor'%3e%3c/path%3e%3c/svg%3e",provider:te.ANTHROPIC,model:se,systemPrompt:"You are a helpful assistant."}],n=h((()=>t.value.find((t=>t.id===e.currentCharacterId)))),o=h((()=>a.value.length&&n.value?a.value.filter((e=>e.cid===n.value.id)).reverse():[])),r=h((()=>{if(o.value.length)return o.value.find((t=>t.id===e.currentChatHistoryId))}));return{getPresetCharacters:i,updatePresetCharacters:()=>{t.value=He(t.value,i()),window.$message.success({message:"é¢„è®¾è§’è‰²å·²æ›´æ–°ï¼"})},characterList:t,allChatHistory:a,isCharacterListFinished:s,isAllChatHistory:l,currentCharacter:n,currentHistoryGroup:o,currentHistory:r}},Le={class:"image-picker"},Ue=["disabled"],je=[(e=>(E("data-v-2c943614"),e=e(),I(),e))((()=>r("span",{class:"mdi mdi-image"},null,-1)))],Se={class:"image-list"},Fe=["onClick"],Ne=B(e({__name:"ImagePicker",props:{images:{},disabled:{type:Boolean,default:!1}},emits:["update:images"],setup(e,{emit:t}){const s=a(e,"images",t),n=async()=>{try{const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image files",accept:{"image/*":[".png",".jpg",".jpeg",".gif",".webp"]}}]});for(const t of e){const e=await t.getFile();if(e.size<=5242880){const t=new FileReader;t.onload=e=>{e.target&&s.value.push(e.target.result)},t.readAsDataURL(e)}else window.$message.warning(`File ${e.name} is larger than 5MB and has been ignored.`)}}catch(e){console.error("Error picking files: ",e)}};return(e,t)=>{const a=C;return l(),i("div",Le,[r("button",{class:"vp-button",disabled:e.disabled,onClick:n,title:"Upload image..."},je,8,Ue),r("div",Se,[(l(!0),i(w,null,A(e.images,((t,n)=>(l(),i("div",{key:n,class:"image-item vp-panel"},[b(a,{"preview-src-list":e.images,"initial-index":n,src:t,"preview-teleported":!0,fit:"contain"},null,8,["preview-src-list","initial-index","src"]),r("button",{onClick:e=>(e=>{s.value.splice(e,1)})(n),class:"btn-no-style",title:"Remove"},"âœ–",8,Fe)])))),128))])])}}}),[["__scopeId","data-v-2c943614"]]),Oe=async(e,t)=>{let a="";a+=`<!doctype html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport"\n        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">\n  <meta http-equiv="X-UA-Compatible" content="ie=edge">\n  <title>${t}</title>`;return a+=`<style>body { font-family: Arial, sans-serif; }\n* {box-sizing: border-box;}\n${(await H((()=>import("./github-markdown-COP4Q2Hz.js")),[],import.meta.url)).default}\n${(await H((()=>import("./github-cxg2BrVm.js")),[],import.meta.url)).default}\n.ai-chat-bubble-system {\n    margin-bottom: 10px;\n    padding: 10px;\n    border: 1px solid #dddddd;\n    font-size: 12px;\n    color: #8a8a8a;\n}\n.btn-jump-wrap {\n    display: none;\n}\n.chat-actions button {\n    display: none;\n}\n.chat-date {\n    margin-top: 10px;\n    opacity: .5;\n}\n.chat-header {\n    margin: -10px -10px 10px;\n    padding: 4px 10px;\n    background-color: #F6F8FA;\n}\n.chat-avatar {\n    display: flex;\n    align-items: center;\n    height: 32px;\n    gap: 10px;\n}\n.chat-avatar img {\n    width: 32px;\n    height: 32px;\n}\n.chat-username {\n    font-weight: bold;\n}\n.ai-chat-bubble {\n    border: 1px solid #dddddd;\n    margin: 10px 0;\n    padding: 10px;\n}\n.hljs-copy-button {\n    display: none;\n}\npre.hljs-code-container {\n    padding: 0;\n}\n.hljs-code-header {\n    padding: 2px 10px;\n    opacity: .5;\n}\n.markdown-body pre > code {\n    white-space: pre-wrap;\n    padding: 10px;\n}\nimg {\n    max-width: 100%;\n}\n</style>`,a+="</head><body>",a+=e.innerHTML,a+="</body></html>",a},Qe=e=>(E("data-v-f59000ed"),e=e(),I(),e),Me={key:0,class:"chat-gpt-wrap vp-bg"},qe={class:"request-below"},Ve=["placeholder"],Je={class:"request-actions"},ze={class:"action-side"},Ke=Qe((()=>r("button",{class:"vp-button",title:"Settings"},[r("span",{class:"mdi mdi-cog"})],-1))),Ge=Qe((()=>r("button",{class:"vp-button",title:"Export"},[r("span",{class:"mdi mdi-tray-arrow-down"})],-1))),Ye=[Qe((()=>r("span",{class:"mdi mdi-unfold-more-horizontal"},null,-1)))],We=["disabled"],Xe={class:"action-side"},Ze=Qe((()=>r("span",{class:"mdi mdi-stop-circle-outline"},null,-1))),et=["disabled"],tt=Qe((()=>r("span",{class:"mdi mdi-send"},null,-1))),at=B(e({__name:"ChatContent",setup(e){const{t:t,locale:a}=p(),d=ee(),{currentCharacter:k,currentHistory:_}=Pe(),C=$(),x=m(!1),E=m(""),I=m(null),B=()=>({role:"system",content:k.value.systemPrompt,timestamp:Date.now()}),D=()=>{k.value&&_.value&&(_.value.history=[B()],I.value=null)},T=m(),R=m(),H=(e=!0,t="smooth")=>{T.value&&setTimeout((()=>{const a=T.value;(e||a.scrollHeight-(a.scrollTop+a.offsetHeight)<400)&&a.scrollTo({top:a.scrollHeight,behavior:t})}))},J=P(H,500,!0),z=()=>{setTimeout((()=>{var e;null==(e=R.value)||e.focus()}))};L(Q.ON_AI_CHARACTER_UPDATE,(()=>{_.value&&(_.value.history.shift(),_.value.history.unshift(B()))}));const{requestChatStream:K,requestChatMessage:G}=le(),Y=h((()=>{var e;return ie[null==(e=k.value)?void 0:e.model]||!1})),W=m([]),X=h((()=>!(!k.value||!_.value)&&(!x.value&&!(!E.value&&!W.value.length)))),Z=U(null),ae=async(e=!1)=>{if(e);else if(!X.value)return;try{if(H(),x.value=!0,I.value={role:"assistant",content:""},!e){let e;e=Y&&W.value.length?[{text:E.value,type:"text"},...W.value.map((e=>({type:"image_url",image_url:{detail:"auto",url:e}})))]:E.value,_.value.history.push({role:"user",content:e,timestamp:Date.now()}),E.value="",W.value=[]}J(!1);const t=new AbortController,{signal:a}=t;Z.value=t;const s=k.value.provider||te.OPEN_AI,l=k.value.model,i=_.value.history.map((e=>({content:e.content,role:e.role})));if(d.stream){await K(s,l,i,(e=>{I.value.content+=e,J(!1)}),{signal:a});const e=I.value;I.value=null,e.timestamp=Date.now(),_.value.history.push(e)}else{const e=await G({provider:s,model:l,messages:i});I.value=null,_.value.history.push({role:"assistant",content:e||"",timestamp:Date.now()})}(async()=>{if(_.value&&_.value.history.length&&!_.value.title)try{const e=[..._.value.history];e.shift(),_.value.title=await G({provider:d.provider,model:d.model,messages:ce(e)})}catch(e){console.error(e)}})()}catch(t){if(Z.value){const{signal:e}=Z.value;if(e.aborted)return void window.$message.warning("Fetch request was aborted")}console.error(t),I.value={role:"assistant",content:t.message,timestamp:Date.now()}}finally{x.value=!1,Z.value=null,J(!1),z()}},se=e=>{"Enter"===e.key&&(d.isEnterSend?e.shiftKey||(e.preventDefault(),ae()):(e.shiftKey||e.ctrlKey)&&(e.preventDefault(),ae()))},ne=e=>{if(!Y.value)return;const t=e.clipboardData;console.log("clipboardData",t);const a=t.items;for(let s=0;s<a.length;s++){const e=a[s];if(/^image/i.test(e.type)){const t=e.getAsFile(),a=new FileReader;a.onload=function(e){const t=e.target.result;t&&W.value.push(t)},a.readAsDataURL(t)}}},oe=()=>{Z.value&&(Z.value.abort(),d.stream||(I.value=null))};j((()=>{oe()})),v(_,(()=>{oe(),_.value&&(_.value.history.length||D(),I.value=null,setTimeout((()=>{z(),H(!0,"auto")})))}),{immediate:!0});const re=async()=>{var e;await(async(e,t="")=>{const a=document.createElement("iframe");a.style.position="absolute",a.style.width="0",a.style.height="0",a.style.border="none",document.body.appendChild(a);const s=a.contentWindow,l=s.document;l.open(),l.write(await Oe(e,t)),l.close(),setTimeout((()=>{const e=document.title;document.title=t,s.print(),document.body.removeChild(a),document.title=e}),500)})(T.value,(null==(e=_.value)?void 0:e.title)||"Chat")},ue=m([{label:"Print to PDF...",iconClass:"mdi mdi-printer",props:{onClick(){re()}}},{label:"Save HTML file",iconClass:"mdi mdi-language-html5",props:{onClick(){(async()=>{var e;const t=(null==(e=_.value)?void 0:e.title)||"Chat";window.$mcUtils.handleExportFile(t,await Oe(T.value,t),".html")})()}}},{split:!0},{label:"Import JSON",iconClass:"mdi mdi-import",props:{async onClick(){_.value.history=await window.$mcUtils.handleImportJson(),window.$message.success(t("msgs.import_success"))}}},{label:"Export JSON",iconClass:"mdi mdi-export",props:{async onClick(){var e;window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName(null,(null==(e=_.value)?void 0:e.title)||"Chat"),JSON.stringify(_.value.history,null,2),".json")}}}]);return(e,a)=>{const p=M,m=q,v=V;return l(),u(O,{name:"fade",mode:"in-out"},{default:f((()=>[s(_)&&s(k)?(l(),i("div",Me,[r("div",{ref_key:"respContainerRef",ref:T,class:"response-container"},[(l(!0),i(w,null,A(s(_).history,((e,t)=>(l(),u(Re,{key:e.timestamp,item:e,"is-dark":s(C).isAppDarkMode,onDelete:e=>s(_).history.splice(t,1),onRetry:a=>((e,t)=>{_.value&&("assistant"===e.role&&_.value.history.splice(t,1),ae(!0))})(e,t),"allow-delete":"","allow-edit":"","allow-retry":t===s(_).history.length-1,character:"assistant"===e.role?s(k):void 0},null,8,["item","is-dark","onDelete","onRetry","allow-retry","character"])))),128)),s(I)?(l(),u(Re,{key:0,item:s(I),"is-dark":s(C).isAppDarkMode,character:s(k),"is-loading":!s(I).content},null,8,["item","is-dark","character","is-loading"])):y("",!0)],512),r("div",qe,[n(r("textarea",{ref_key:"inputRef",ref:R,class:"vp-input question-input","onUpdate:modelValue":a[0]||(a[0]=e=>c(E)?E.value=e:null),type:"textarea",placeholder:s(d).isEnterSend?s(t)("ai.enter_send_tips_1"):s(t)("ai.enter_send_tips_2"),onKeydown:se,onPaste:ne},null,40,Ve),[[o,s(E)]]),r("div",Je,[r("div",ze,[b(p,{width:"400",placement:"top-start",trigger:"click",teleported:!1,persistent:!1,"popper-style":"padding: 0","auto-close":0},{reference:f((()=>[Ke])),default:f((()=>[b(de,{style:{"max-height":"70vh","overflow-y":"auto"}})])),_:1}),b(S,{options:s(ue)},{default:f((()=>[Ge])),_:1},8,["options"]),r("button",{onClick:a[1]||(a[1]=e=>H()),onContextmenu:a[2]||(a[2]=F((e=>{T.value&&setTimeout((()=>{T.value.scrollTo({top:0,behavior:"smooth"})}))}),["prevent"])),class:"vp-button",title:"Scroll to bottom, right click scroll to top"},Ye,32),b(m,{onConfirm:D,title:"Confirm clear chat history?",teleported:!1},{reference:f((()=>[r("button",{class:"vp-button",disabled:s(x)},g(s(t)("actions.clear")),9,We)])),_:1})]),r("div",Xe,[b(v,null,{default:f((()=>[N(g(s(k).model),1)])),_:1}),b(Ne,{images:s(W),"onUpdate:images":a[3]||(a[3]=e=>c(W)?W.value=e:null),disabled:s(x)||!s(Y)},null,8,["images","disabled"]),s(x)?(l(),i("button",{key:0,class:"vp-button",onClick:oe},[Ze,N(" "+g(s(t)("ai.stop_generation")),1)])):(l(),i("button",{key:1,class:"vp-button primary",disabled:!s(X),onClick:a[4]||(a[4]=e=>ae())},[tt,N(" "+g(s(t)("actions.send")),1)],8,et))])])])])):y("",!0)])),_:1})}}}),[["__scopeId","data-v-f59000ed"]]),st=({index:e,cb:t})=>{const a=e=>e.target.closest(".sub-item");return{draggable:!0,onDragstart:t=>{a(t),t.dataTransfer.setData("data-transfer-index",e)},onDragover:e=>{e.preventDefault();a(e).classList.add("_drag-over")},onDragleave:e=>{e.preventDefault();a(e).classList.remove("_drag-over")},onDrop:s=>{s.preventDefault();a(s).classList.remove("_drag-over");const l=Number(s.dataTransfer.getData("data-transfer-index"));t(l,e,s)}}},lt={class:"ai-side-characters"},it=e({__name:"SideCharacters",setup(e){const{t:t}=p(),a=ee(),{characterList:n,allChatHistory:o,updatePresetCharacters:r,isCharacterListFinished:c}=Pe(),d=m(!1),u=m(!1),y=(e={})=>({id:e.id||"",name:e.name||"",desc:e.desc||"",avatar:e.avatar||"",provider:e.provider||te.OPEN_AI,model:e.model||ae,systemPrompt:e.systemPrompt||""}),g=m(y()),w=(e,t)=>{const a=[...n.value];if(e<0||e>=a.length||t<0||t>=a.length||e===t)return;const[s]=a.splice(e,1),l=e<t?t-1:t;a.splice(l,0,s),n.value=a.map(R)},A=h((()=>[{label:t("ai.characters"),key:"characters",hideExpandIcon:!0,actionRender:()=>me([{label:`âž• ${t("actions.create")}`,props:{onClick:()=>{d.value=!0,g.value=y(),u.value=!0}}},{label:`ðŸ“¤ ${t("actions.export")} JSON...`,props:{onClick:async()=>{window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName("AICharacters"),JSON.stringify(n.value,null,2),".json")}}},{label:`ðŸ“¥ ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();n.value=He(n.value,e||[]),window.$message.success("Import success!")}}},{label:`ðŸ—‘ï¸ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.delete_all"),{type:"warning"}).then((()=>{n.value=[],o.value=[]})).catch()}}},{label:t("ai.geng_xin_yu_she_jue"),iconClass:"mdi mdi-shape-plus-outline",props:{onClick:()=>{r()}}}]),children:n.value.map(((e,s)=>({key:e.id,label:`${e.name}`,subtitle:`${e.desc} [${e.model}]`,icon:e.avatar||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAMAAABlApw1AAAAM1BMVEX6+vr6+vr6+vrw8PDg4ODIyMi4uLjAwMCPj4+QkJCYmJigoKCoqKiwsLDQ0NDY2Njo6OiSEekXAAAAAnRSTlP+/T+gj6oAAAKXSURBVHgB7doHkq06DIThecihRzLm7H+17+acoE4zclX/K+Ajg/Wyrd2LAAIIIIAAAggggAACCCBAjgQQQAABBBBAAAEEEEAAAQQQQAABBLBSWwQAxNhrWQxgx3B8l+9zHYBVxy+KZiwAf/M/VS0/4Aj8oZjJAdbxl7plBljgr4XlBVgAfAEPYAHwBTyABcAX8AAWAF9ABHScqOcDTJzqyAawwKnCkgEqTtZzAQxnc0sFaDhdTwUIMA8BHzBxoSMRYMeFRiKA40JuaQAFlyppABWXqmkAOy7V0gAGLhVpALE6ABdjAgQQQBcxHzDSABoutetVQi9znzLHhTzR98DgXgJ8wIELTSqAfw5Fqr8SHadrXAD/EFgqwNYJ/7X0c5d5I5pa4NASE3+RT8usJEGYRg007PGHZuAPxUEct+EfBO+2xshZC/Lm86cW5+74Lh+HLTY3Wuo+AgAiWi2mwVcBUiWAAAIIUHo4npRHKzcDZuDJxbwRYAOEht0FsAClsHsAFgBfQAQM0Bp3ACaIzRsAAWLBBxRQK3RAA7VOBwSoBR3goOZ0AMgJIIAAuo2+KWCs/iTe6YC++qvEAWoHHWCgZnTANvjXMBdQV/8iMxCzxT/q23YHoICWUQH8Q9Du+jPnoPRqVAD/adzv+zsdIBQbE8A/icJuBGwPPLvXx70rNJP/DOYBCILXef8i3+F4Wl7eYpXSgn/9UgGbNTylZhsPwF+s9IO5Tsw/CN02PoBHGMZfqecRvJUksxJ25VqIbpmGPUo7ZfBe8k2rPOpw/EM+6iPtuE2p7U8Kj1YfC0zultnbGBGfKB4x9tbnYRp4EkAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEODNE0AAARbvv/8B8Ba3QAWB51wAAAAASUVORK5CYII=",cls:a.currentCharacterId===e.id?"active":"",clickFn:()=>{a.currentCharacterId=e.id},itemProps:st({index:s,cb:w}),actionRender:()=>me([{label:`âœï¸ ${t("actions.edit")}`,props:{onClick:()=>{d.value=!1,g.value=y(e),u.value=!0}}},{label:`ðŸ“„ ${t("actions.duplicate")}...`,props:{onClick:async()=>{d.value=!0,g.value=y(e),u.value=!0}}},{label:`ðŸ—‘ï¸ ${t("actions.delete")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.confirm"),{type:"warning"}).then((()=>{o.value=o.value.filter((t=>t.cid!==e.id)).map(R),n.value.splice(s,1)})).catch()}}}])})))}]));v(c,(e=>{e&&(n.value.length||r(),setTimeout((()=>{document.querySelectorAll(".ai-option-ui .sub-item.active").forEach((e=>{e.scrollIntoView({behavior:"smooth",block:"center"})}))}),100))}));const k=m({id:{required:!0,trigger:"blur",validator:(e,t)=>{if(!t)return new Error("id is required");if(d.value){if(n.value.findIndex((e=>e.id===t))>-1)return new Error("id can not be same")}return!0}},provider:{required:!0,trigger:"blur"},model:{required:!0,trigger:"blur"},name:{required:!0,trigger:"blur"}}),_=h((()=>{const e=ne(g.value.provider);return[[{type:pe.INPUT,key:"name",label:t("ai.name"),props:{onChange:()=>{if(d.value){const e=g.value.name.trim();g.value.name=e,!g.value.id&&e&&(g.value.id=window.$mcUtils.formatI18nKey(e))}}}},{type:pe.INPUT,key:"avatar",label:`${t("ai.avatar")} URL`,props:{clearable:!0},render:()=>K("button",{type:"button",class:"btn-no-style mdi mdi-image-plus",onClick:async()=>{const e=await Y.chooseFileToBase64({accept:"image/*"});"string"==typeof e&&(g.value.avatar=e)}})}],[{type:pe.INPUT,key:"id",label:`ID (${t("ai.chuang_jian_hou_bu_k")})`,disabled:!d.value},{type:pe.INPUT,key:"desc",label:t("common.bei_zhu"),placeholder:""}],[{type:pe.SELECT,options:oe,key:"provider",label:t("ai.ti_gong_shang"),props:{filterable:!0,onChange(){g.value.model=ne(g.value.provider)[0].value}}},{type:pe.SELECT,options:e,key:"model",label:t("ai.model"),props:{allowCreate:!0,filterable:!0}}],{type:pe.INPUT,key:"systemPrompt",label:t("ai.system_prompt"),props:{type:"textarea",rows:8}}]})),C=()=>{if(u.value=!1,d.value)return void n.value.push(g.value);const e=n.value.findIndex((e=>e.id===g.value.id));e>-1&&n.value.splice(e,1,g.value),J.emit(Q.ON_AI_CHARACTER_UPDATE)};return(e,a)=>{const n=z;return l(),i("div",lt,[b(ue,{class:"ai-option-ui","option-list":A.value},null,8,["option-list"]),b(n,{draggable:"",top:"10vh",width:"700",modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),title:d.value?s(t)("actions.create"):s(t)("actions.edit")},{default:f((()=>[b(ve,{"form-schema":{model:g.value,rules:k.value,props:{labelPosition:"top"},formItems:_.value},onOnSubmit:C},null,8,["form-schema"])])),_:1},8,["modelValue","title"])])}}}),nt={class:"ai-side-history"},ot=e({__name:"SideHistory",setup(e){const{t:t}=p(),a=ee(),{currentCharacter:n,allChatHistory:o,isCharacterListFinished:r,isAllChatHistory:c,currentHistoryGroup:d,currentHistory:u}=Pe(),m=()=>{if(!n.value)return;console.log("[isCharacterListFinished]",r.value),console.log("[isAllChatHistory]",c.value);const e=X(),t={id:e,cid:n.value.id,title:"",timestamp:Date.now(),history:[]};o.value.push(t),a.currentChatHistoryId=e};v(n,(e=>{r.value&&c.value&&y()})),v(c,(e=>{e&&y()}));const y=()=>{setTimeout((()=>{n.value&&!d.value.length&&m(),!u.value&&d.value.length&&(a.currentChatHistoryId=d.value[0].id)}))},g=h((()=>{if(!n.value)return[];const e=t("ai.yu_current_character",[n.value.name]),s=()=>{o.value=o.value.filter((e=>e.cid!==n.value.id)).map(R)};return[{label:e,key:"history",hideExpandIcon:!0,actionRender:()=>me([{label:`ðŸ“¤ ${t("actions.export")} JSON...`,props:{onClick:async()=>{const t=o.value.filter((e=>e.cid===n.value.id));window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName(e),JSON.stringify(t,null,2),".json")}}},{label:`ðŸ“¥ ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();o.value=e||[];const t=o.value.filter((e=>e.cid===n.value.id)),a=He(t,e);s(),o.value=a,window.$message.success("Import success!")}}},{label:`ðŸ—‘ï¸ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.delete_all"),{type:"warning"}).then((()=>{s()})).catch()}}}]),children:[{label:`${t("ai.new_chat")}`,iconClass:"mdi mdi-plus",clickFn:()=>{m()}},...d.value.map(((s,l)=>({key:s.id,label:s.title||e,subtitle:W(s.timestamp),cls:a.currentChatHistoryId===s.id?"active":"",clickFn:()=>{a.currentChatHistoryId=s.id},actionRender:()=>me([{label:`âœï¸ ${t("actions.rename")}`,props:{onClick:async()=>{const e=await window.$mcUtils.showInputPrompt({title:`${t("actions.rename")}: ${s.title}`,value:s.title});s.title=e}}},{label:`ðŸ—‘ï¸ ${t("actions.delete")}`,props:{onClick:()=>{const e=o.value.findIndex((e=>e.id===s.id));e>-1&&o.value.splice(e,1)}}}])})))]}]}));return(e,t)=>(l(),i("div",nt,[b(ue,{class:"ai-option-ui","option-list":s(g)},null,8,["option-list"])]))}}),rt={class:"ai-chat-root vp-panel"},ct={key:0,class:"mdi mdi-chevron-right"},dt={key:1,class:"mdi mdi-chevron-left"},ut=e({__name:"ChatRoot",setup(e){const t=ee();return(e,a)=>(l(),i("div",rt,[r("div",{class:d(["chat-sidebar",{_expand:s(t).isSidebarExpand}])},[b(it),b(ot),r("button",{class:"btn-toggle-expand btn-no-style",onClick:a[0]||(a[0]=e=>s(t).isSidebarExpand=!s(t).isSidebarExpand)},[s(t).isSidebarExpand?(l(),i("span",dt)):(l(),i("span",ct))])],2),b(at)]))}});export{ut as _,he as a};
