import{d as e,t,S as a,r as l,bE as s,K as i,x as n,o,b as r,k as c,v as u,e as d,W as p,h as v,bF as m,c as h,g,F as y,P as f,f as b,p as A,m as w,L as k,ac as C,Y as _,Z as x,$ as B,_ as E,bG as I,bH as H,D,u as T,s as $,ae as R,M as L,J as U,O as P,G as j,ay as Q,a4 as M,U as F,I as S,y as q,R as N}from"./index-D7imv_Md.js";/* empty css                      *//* empty css                        */import{_ as V}from"./index.vue_vue_type_script_setup_true_lang-B7mdx2Oz.js";/* empty css                   */import{c as O,b as J}from"./base64-utils-CS7oSewj.js";import{f as z,g as G}from"./index-BR_HEkHY.js";import{u as K}from"./use-ai-settings-BqE_47hv.js";import{C as Y,u as W,c as X}from"./ai-settings-IJi9YQ4b.js";import{u as Z,a as ee}from"./prompts-DbIqStkv.js";import{u as te}from"./useIDBKeyval-BIf4fra4.js";import{_ as ae,A as le}from"./index.vue_vue_type_style_index_0_lang-DEuY5zHr.js";const se="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20xmlns:xlink='http://www.w3.org/1999/xlink'%20viewBox='0%200%202406%202406'%3e%3cpath%20d='M1%20578.4C1%20259.5%20259.5%201%20578.4%201h1249.1c319%200%20577.5%20258.5%20577.5%20577.4V2406H578.4C259.5%202406%201%202147.5%201%201828.6V578.4z'%20fill='%2374aa9c'/%3e%3cpath%20id='a'%20d='M1107.3%20299.1c-197.999%200-373.9%20127.3-435.2%20315.3L650%20743.5v427.9c0%2021.4%2011%2040.4%2029.4%2051.4l344.5%20198.515V833.3h.1v-27.9L1372.7%20604c33.715-19.52%2070.44-32.857%20108.47-39.828L1447.6%20450.3C1361%20353.5%201237.1%20298.5%201107.3%20299.1zm0%20117.5-.6.6c79.699%200%20156.3%2027.5%20217.6%2078.4-2.5%201.2-7.4%204.3-11%206.1L952.8%20709.3c-18.4%2010.4-29.4%2030-29.4%2051.4V1248l-155.1-89.4V755.8c-.1-187.099%20151.601-338.9%20339-339.2z'%20fill='%23fff'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(60%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(120%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(180%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(240%201203%201203)'/%3e%3cuse%20xlink:href='%23a'%20transform='rotate(300%201203%201203)'/%3e%3c/svg%3e",ie=["innerHTML"],ne=e({__name:"TextContent",props:{isDark:{type:Boolean,default:!1},isEditing:{type:Boolean,default:!1},text:{default:""}},emits:["update:text"],setup(e,{emit:h}){const g=e,{text:y,isEditing:f}=t(g),b=a(g,"text",h),A=l(""),w=()=>{A.value=m.render(y.value)};s(y,(e=>{f.value||w()}),{throttle:100,trailing:!0,immediate:!0}),i(f,(e=>{e||w()}));const k=e=>{const t=e.target;if(t){if("A"===t.tagName)return void(t.target="_blank");if(t.classList.contains("hljs-copy-button")){const e=t.parentElement.nextSibling.textContent;window.$qlUtils.copy(e)}}};return(e,t)=>n(f)?(o(),r("div",{key:0,class:v(["chat-content vp-bg",{"markdown-body-dark":e.isDark}]),style:{width:"100%"}},[c(d("textarea",{class:"vp-input","onUpdate:modelValue":t[0]||(t[0]=e=>p(b)?b.value=e:null),rows:"10",ref:"editInputRef",style:{width:"100%","font-size":"16px"}},null,512),[[u,n(b)]])],2)):(o(),r("div",{key:1,onClick:k,class:v(["chat-content markdown-body vp-bg",{"markdown-body-dark":e.isDark}]),innerHTML:n(A)},null,10,ie))}}),oe=e=>(x("data-v-d0775aa1"),e=e(),B(),e),re=["innerHTML"],ce={class:"chat-side"},ue={class:"chat-header"},de=["title"],pe=["src","alt","title"],ve=[oe((()=>d("i",{class:"fa fa-angle-double-up","aria-hidden":"true"},null,-1)))],me=[oe((()=>d("i",{class:"fa fa-angle-double-down","aria-hidden":"true"},null,-1)))],he={style:{width:"50px",height:"50px"},"element-loading-background":"transparent"},ge={key:1,class:"chat-images"},ye=["src","alt"],fe={class:"chat-actions"},be={key:0,class:"chat-date font-code"},Ae={class:"btn-no-style"},we=E(e({__name:"ChatBubble",props:{isDark:{type:Boolean,default:!1},allowDelete:{type:Boolean,default:!1},allowEdit:{type:Boolean},allowRetry:{type:Boolean,default:!1},isLoading:{type:Boolean,default:!1},character:{},item:{}},emits:["delete","retry"],setup(e,{emit:a}){const s=e,{item:p}=t(s),m=l(!1),x=l();i(m,(()=>{setTimeout((()=>{x.value&&x.value.focus()}))}));const B=h((()=>"assistant"===p.value.role)),E=l(),I=()=>{const e=E.value;e.parentElement.scrollTo({top:e.offsetTop-10,behavior:"smooth"})},H=()=>{const e=E.value,t=e.parentElement;t.scrollTo({top:e.offsetTop+e.offsetHeight-t.offsetHeight+10,behavior:"smooth"})};return(e,t)=>{const a=C,l=_;return"system"===n(p).role?(o(),r("div",{key:0,ref_key:"rootRef",ref:E,class:v(["ai-chat-bubble-system",{isEditing:n(m)}])},[n(m)?c((o(),r("textarea",{key:0,ref_key:"editInputRef",ref:x,class:"vp-input","onUpdate:modelValue":t[0]||(t[0]=e=>n(p).content=e),rows:"6",onBlur:t[1]||(t[1]=e=>m.value=!1)},null,544)),[[u,n(p).content]]):n(p).content?(o(),r("div",{key:1,class:v(["chat-content",{"markdown-body-dark":e.isDark}]),innerHTML:`[${n(p).role}] ${n(p).content}`,onClick:t[2]||(t[2]=e=>m.value=!0)},null,10,re)):g("",!0)],2)):(o(),r("div",{key:1,ref_key:"rootRef",ref:E,class:v(["ai-chat-bubble",{isReply:n(B),isEditing:n(m)}])},[d("div",ce,[d("div",ue,[d("div",{class:"chat-avatar",title:n(p).role},[e.character?(o(),r("img",{key:0,src:e.character.avatar||n(se),alt:n(p).role,title:e.character.name},null,8,pe)):(o(),r(y,{key:1},[f(b(n(p).role),1)],64))],8,de),d("div",{class:"btn-jump-wrap"},[d("button",{class:"btn-no-style btn-jump",onClick:I},ve),d("button",{class:"btn-no-style btn-jump",onClick:H},me)])])]),d("div",{class:v(["chat-body",{isEditing:n(m)}])},[e.isLoading?(o(),r("div",{key:0,class:v(["chat-content markdown-body vp-bg",{"markdown-body-dark":e.isDark}])},[c(d("div",he,null,512),[[l,!0]])],2)):"string"==typeof n(p).content?(o(),A(ne,{key:1,text:n(p).content,"onUpdate:text":t[3]||(t[3]=e=>n(p).content=e),"is-dark":e.isDark,"is-editing":n(m)},null,8,["text","is-dark","is-editing"])):(Array.isArray(n(p).content),o(!0),r(y,{key:2},w(n(p).content,((t,a)=>(o(),r(y,{key:a},["text"===t.type?(o(),A(ne,{key:0,text:t.text,"onUpdate:text":e=>t.text=e,"is-dark":e.isDark,"is-editing":n(m)},null,8,["text","onUpdate:text","is-dark","is-editing"])):"image_url"===t.type&&t.image_url?(o(),r("div",ge,[d("img",{src:t.image_url.url,alt:t.image_url.detail},null,8,ye)])):g("",!0)],64)))),128)),d("div",fe,[n(p).timestamp?(o(),r("div",be,b(n(z)(n(p).timestamp)),1)):g("",!0),n(m)?(o(),r("button",{key:1,class:"btn-no-style",onClick:t[4]||(t[4]=e=>m.value=!1)}," ✅ "+b(e.$t("actions.done")),1)):(o(),r(y,{key:2},[d("button",{class:"btn-no-style",onClick:t[5]||(t[5]=e=>n(O)(n(p).content))}," 📋 "+b(e.$t("actions.copy")),1),e.allowRetry?(o(),r("button",{key:0,class:"btn-no-style",onClick:t[6]||(t[6]=t=>e.$emit("retry"))}," 🔄 "+b(e.$t("actions.retry")),1)):g("",!0),e.allowEdit?(o(),r("button",{key:1,class:"btn-no-style",onClick:t[7]||(t[7]=e=>m.value=!0)}," 📝 "+b(e.$t("actions.edit")),1)):g("",!0),e.allowDelete?(o(),A(a,{key:2,onConfirm:t[8]||(t[8]=t=>e.$emit("delete",n(p))),title:e.$t("actions.confirm"),teleported:!1},{reference:k((()=>[d("button",Ae,"🗑️ "+b(e.$t("actions.delete")),1)])),_:1},8,["title"])):g("",!0)],64))])],2)],2))}}}),[["__scopeId","data-v-d0775aa1"]]),ke=(e,t)=>{const a=new Map(e.map((e=>[e.id,e])));return t.forEach((e=>{a.set(e.id,e)})),Array.from(a.values()).map(H)},Ce=I((()=>{const{data:e,isFinished:t}=te("page_craft_ai_characters",[{id:"default",name:"ChatGPT",desc:"",avatar:se,model:Y.GPT4oMini,systemPrompt:"You are a helpful assistant."}]),{data:a,isFinished:l}=te("page_craft_ai_history_group",[]);return{characterList:e,allChatHistory:a,isCharacterListFinished:t,isAllChatHistory:l}})),_e=()=>{const e=W(),{characterList:t,allChatHistory:a,isCharacterListFinished:l,isAllChatHistory:s}=Ce(),i=h((()=>t.value.find((t=>t.id===e.currentCharacterId)))),n=h((()=>a.value.length&&i.value?a.value.filter((e=>e.cid===i.value.id)).reverse():[])),o=h((()=>{if(n.value.length)return n.value.find((t=>t.id===e.currentChatHistoryId))}));return{characterList:t,allChatHistory:a,isCharacterListFinished:l,isAllChatHistory:s,currentCharacter:i,currentHistoryGroup:n,currentHistory:o}},xe={class:"image-picker"},Be=["disabled"],Ee=[(e=>(x("data-v-7d65743b"),e=e(),B(),e))((()=>d("i",{class:"fa fa-file-image-o","aria-hidden":"true"},null,-1)))],Ie={class:"image-list"},He=["src"],De=["onClick"],Te=E(e({__name:"ImagePicker",props:{images:{},disabled:{type:Boolean,default:!1}},emits:["update:images"],setup(e,{emit:t}){const l=a(e,"images",t),s=async()=>{try{const e=await window.showOpenFilePicker({multiple:!0,types:[{description:"Image files",accept:{"image/*":[".png",".jpg",".jpeg",".gif",".webp"]}}]});for(const t of e){const e=await t.getFile();if(e.size<=5242880){const t=new FileReader;t.onload=e=>{e.target&&l.value.push(e.target.result)},t.readAsDataURL(e)}else window.$message.warning(`File ${e.name} is larger than 5MB and has been ignored.`)}}catch(e){console.error("Error picking files: ",e)}};return(e,t)=>(o(),r("div",xe,[d("button",{class:"vp-button",disabled:e.disabled,onClick:s,title:"Upload image..."},Ee,8,Be),d("div",Ie,[(o(!0),r(y,null,w(e.images,((e,t)=>(o(),r("div",{key:t,class:"image-item vp-panel"},[d("img",{src:e},null,8,He),d("button",{onClick:e=>(e=>{l.value.splice(e,1)})(t),class:"btn-no-style",title:"Remove"},"✖",8,De)])))),128))])]))}}),[["__scopeId","data-v-7d65743b"]]),$e=e=>(x("data-v-7dd52887"),e=e(),B(),e),Re={key:0,class:"chat-gpt-wrap vp-bg"},Le={class:"request-below"},Ue=["placeholder"],Pe={class:"request-actions"},je={class:"action-side"},Qe=$e((()=>d("button",{class:"vp-button"},[d("i",{class:"fa fa-cog","aria-hidden":"true"})],-1))),Me=[$e((()=>d("i",{class:"fa fa-long-arrow-down","aria-hidden":"true"},null,-1)))],Fe={class:"action-side"},Se=["disabled"],qe=$e((()=>d("i",{class:"fa fa-stop","aria-hidden":"true"},null,-1))),Ne=["disabled"],Ve=$e((()=>d("i",{class:"fa fa-play","aria-hidden":"true"},null,-1))),Oe=E(e({__name:"ChatContent",setup(e){const{t:t,locale:a}=D(),s=W(),{currentCharacter:v,currentHistory:m}=_e(),{aiSettingsOptions:_}=K(),x=T(),B=l(!1),E=l(""),I=l(null),H=()=>({role:"system",content:v.value.systemPrompt,timestamp:Date.now()}),M=()=>{v.value&&m.value&&(m.value.history=[H()],I.value=null)},F=l(),S=l(),q=(e=!0)=>{F.value&&setTimeout((()=>{const t=F.value;(e||t.scrollHeight-(t.scrollTop+t.offsetHeight)<400)&&t.scrollTo({top:t.scrollHeight,behavior:"smooth"})}))},N=$(q,500,!0),O=()=>{setTimeout((()=>{var e;null==(e=S.value)||e.focus()}))};R(j.ON_AI_CHARACTER_UPDATE,(()=>{m.value&&(m.value.history.shift(),m.value.history.unshift(H()))}));const{requestChatCompletion:J,requestAiChatMessage:z,canUseVision:G}=Z(),X=h((()=>{var e;return G(null==(e=v.value)?void 0:e.model)})),te=l([]),ae=L(null),le=async(e=!1)=>{var t;if(v.value&&m.value&&(e||E.value))try{if(q(),B.value=!0,I.value={role:"assistant",content:""},!e){let e;e=X&&te.value.length?[{text:E.value,type:"text"},...te.value.map((e=>({type:"image_url",image_url:{detail:"auto",url:e}})))]:E.value,m.value.history.push({role:"user",content:e,timestamp:Date.now()}),E.value="",te.value=[]}N(!1);const a=new AbortController,{signal:l}=a;ae.value=a;const s=await J({model:v.value.model,messages:m.value.history.map((e=>({content:e.content,role:e.role})))},(e=>{I.value.content+=e,N(!1)}),{signal:l});if("string"==typeof s){const e=I.value;I.value=null,e.timestamp=Date.now(),m.value.history.push(e)}else{I.value=null;const e=(null==(t=s.choices[0])?void 0:t.message)||{};m.value.history.push({role:"assistant",content:e.content||"",timestamp:1e3*s.created})}(async()=>{if(m.value&&m.value.history.length&&!m.value.title)try{const e=[...m.value.history];e.shift(),m.value.title=await z(ee(e),{model:Y.GPT4oMini})}catch(e){console.error(e)}})()}catch(a){if(ae.value){const{signal:e}=ae.value;if(e.aborted)return void window.$message.warning("Fetch request was aborted")}console.error(a),I.value={role:"assistant",content:a.message,timestamp:Date.now()}}finally{B.value=!1,ae.value=null,N(!1),O()}},se=e=>{"Enter"===e.key&&(e.shiftKey||(e.preventDefault(),le()))},ie=()=>{ae.value&&(ae.value.abort(),s.stream||(I.value=null))};return U((()=>{ie()})),i(m,(()=>{ie(),m.value&&(m.value.history.length||M(),I.value=null,setTimeout((()=>{O(),q()})))}),{immediate:!0}),(e,a)=>{const l=Q,s=C;return n(m)&&n(v)?(o(),r("div",Re,[d("div",{ref_key:"respContainerRef",ref:F,class:"response-container"},[(o(!0),r(y,null,w(n(m).history,((e,t)=>(o(),A(we,{key:t,item:e,"is-dark":n(x).isAppDarkMode,onDelete:e=>n(m).history.splice(t,1),onRetry:a=>((e,t)=>{m.value&&("assistant"===e.role&&m.value.history.splice(t,1),le(!0))})(e,t),"allow-delete":"","allow-edit":"","allow-retry":t===n(m).history.length-1,character:"assistant"===e.role?n(v):void 0},null,8,["item","is-dark","onDelete","onRetry","allow-retry","character"])))),128)),n(I)?(o(),A(we,{key:0,item:n(I),"is-dark":n(x).isAppDarkMode,character:n(v),"is-loading":!n(I).content},null,8,["item","is-dark","character","is-loading"])):g("",!0)],512),d("div",Le,[c(d("textarea",{ref_key:"inputRef",ref:S,class:"vp-input question-input","onUpdate:modelValue":a[0]||(a[0]=e=>p(E)?E.value=e:null),type:"textarea",rows:"5",placeholder:n(t)("ai.hui_che_jian_ti_jiao"),onKeydown:se},null,40,Ue),[[u,n(E)]]),d("div",Pe,[d("div",je,[P(l,{width:"400",placement:"top-start",trigger:"click",teleported:!1},{reference:k((()=>[Qe])),default:k((()=>[P(V,{"option-list":n(_)},null,8,["option-list"])])),_:1}),d("button",{onClick:a[1]||(a[1]=e=>q()),class:"vp-button"},Me)]),d("div",Fe,[f(b(n(v).model)+" ",1),n(X)?(o(),A(Te,{key:0,images:n(te),"onUpdate:images":a[2]||(a[2]=e=>p(te)?te.value=e:null),disabled:n(B)},null,8,["images","disabled"])):g("",!0),P(s,{onConfirm:M,title:"Confirm clear chat history?",teleported:!1},{reference:k((()=>[d("button",{class:"vp-button",disabled:n(B)},b(n(t)("actions.clear")),9,Se)])),_:1}),n(B)?(o(),r("button",{key:1,class:"vp-button",onClick:ie},[qe,f(" "+b(n(t)("ai.stop_generation")),1)])):(o(),r("button",{key:2,class:"vp-button primary",disabled:n(B)||!n(E),onClick:a[3]||(a[3]=e=>le())},[Ve,f(" "+b(n(t)("actions.send")),1)],8,Ne))])])])])):g("",!0)}}}),[["__scopeId","data-v-7dd52887"]]),Je=({index:e,cb:t})=>{const a=e=>e.target.closest(".sub-item");return{draggable:!0,onDragstart:t=>{a(t),t.dataTransfer.setData("data-transfer-index",e)},onDragover:e=>{e.preventDefault();a(e).classList.add("_drag-over")},onDragleave:e=>{e.preventDefault();a(e).classList.remove("_drag-over")},onDrop:l=>{l.preventDefault();a(l).classList.remove("_drag-over");const s=Number(l.dataTransfer.getData("data-transfer-index"));t(s,e,l)}}},ze=(e=[],t)=>M(F,{options:e,props:t}),Ge={class:"ai-side-characters"},Ke=e({__name:"SideCharacters",setup(e){const{t:t}=D(),a=W(),{characterList:s,allChatHistory:i}=_e(),c=l(!1),u=l(!1),d=(e={})=>({id:e.id||"",name:e.name||"",desc:e.desc||"",avatar:e.avatar||"",model:e.model||Y.GPT4oMini,systemPrompt:e.systemPrompt||""}),p=l(d()),v=(e,t)=>{const a=[...s.value];if(e<0||e>=a.length||t<0||t>=a.length||e===t)return;const[l]=a.splice(e,1),i=e<t?t-1:t;a.splice(i,0,l),s.value=a.map(H)},m=h((()=>[{label:t("ai.characters"),key:"characters",hideExpandIcon:!0,actionRender:()=>ze([{label:`➕ ${t("actions.create")}`,props:{onClick:()=>{c.value=!0,p.value=d(),u.value=!0}}},{label:`📤 ${t("actions.export")} JSON...`,props:{onClick:async()=>{window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName("AICharacters"),JSON.stringify(s.value,null,2),".json")}}},{label:`📥 ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();s.value=ke(s.value,e||[]),window.$message.success("Import success!")}}},{label:`🗑️ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.delete_all"),{type:"warning"}).then((()=>{s.value=[],i.value=[]})).catch()}}}]),children:s.value.map(((e,l)=>({key:e.id,label:`${e.name}`,subtitle:`${e.desc} [${e.model}]`,icon:e.avatar||"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAMAAABlApw1AAAAM1BMVEX6+vr6+vr6+vrw8PDg4ODIyMi4uLjAwMCPj4+QkJCYmJigoKCoqKiwsLDQ0NDY2Njo6OiSEekXAAAAAnRSTlP+/T+gj6oAAAKXSURBVHgB7doHkq06DIThecihRzLm7H+17+acoE4zclX/K+Ajg/Wyrd2LAAIIIIAAAggggAACCCBAjgQQQAABBBBAAAEEEEAAAQQQQAABBLBSWwQAxNhrWQxgx3B8l+9zHYBVxy+KZiwAf/M/VS0/4Aj8oZjJAdbxl7plBljgr4XlBVgAfAEPYAHwBTyABcAX8AAWAF9ABHScqOcDTJzqyAawwKnCkgEqTtZzAQxnc0sFaDhdTwUIMA8BHzBxoSMRYMeFRiKA40JuaQAFlyppABWXqmkAOy7V0gAGLhVpALE6ABdjAgQQQBcxHzDSABoutetVQi9znzLHhTzR98DgXgJ8wIELTSqAfw5Fqr8SHadrXAD/EFgqwNYJ/7X0c5d5I5pa4NASE3+RT8usJEGYRg007PGHZuAPxUEct+EfBO+2xshZC/Lm86cW5+74Lh+HLTY3Wuo+AgAiWi2mwVcBUiWAAAIIUHo4npRHKzcDZuDJxbwRYAOEht0FsAClsHsAFgBfQAQM0Bp3ACaIzRsAAWLBBxRQK3RAA7VOBwSoBR3goOZ0AMgJIIAAuo2+KWCs/iTe6YC++qvEAWoHHWCgZnTANvjXMBdQV/8iMxCzxT/q23YHoICWUQH8Q9Du+jPnoPRqVAD/adzv+zsdIBQbE8A/icJuBGwPPLvXx70rNJP/DOYBCILXef8i3+F4Wl7eYpXSgn/9UgGbNTylZhsPwF+s9IO5Tsw/CN02PoBHGMZfqecRvJUksxJ25VqIbpmGPUo7ZfBe8k2rPOpw/EM+6iPtuE2p7U8Kj1YfC0zultnbGBGfKB4x9tbnYRp4EkAAAQQQQAABBBBAAAEEEEAAAQQQQAABBBBAAAEEEODNE0AAARbvv/8B8Ba3QAWB51wAAAAASUVORK5CYII=",cls:a.currentCharacterId===e.id?"active":"",clickFn:()=>{a.currentCharacterId=e.id},itemProps:Je({index:l,cb:v}),actionRender:()=>ze([{label:`✏️ ${t("actions.edit")}`,props:{onClick:()=>{c.value=!1,p.value=d(e),u.value=!0}}},{label:`📄 ${t("actions.duplicate")}...`,props:{onClick:async()=>{c.value=!0,p.value=d(e),u.value=!0}}},{label:`🗑️ ${t("actions.delete")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.confirm"),{type:"warning"}).then((()=>{i.value=i.value.filter((t=>t.cid!==e.id)).map(H),s.value.splice(l,1)})).catch()}}}])})))}]));S((()=>{setTimeout((()=>{document.querySelectorAll(".ai-option-ui .sub-item.active").forEach((e=>{e.scrollIntoView({behavior:"smooth",block:"center"})}))}),100)}));const g=l({id:{required:!0,trigger:"blur",validator:(e,t)=>{if(!t)return new Error("id is required");if(c.value){if(s.value.findIndex((e=>e.id===t))>-1)return new Error("id can not be same")}return!0}},model:{required:!0,trigger:"blur"},name:{required:!0,trigger:"blur"},systemPrompt:{required:!0,trigger:"blur"}}),y=h((()=>[[{type:le.INPUT,key:"name",label:t("ai.name"),props:{onChange:()=>{if(c.value){const e=p.value.name.trim();p.value.name=e,!p.value.id&&e&&(p.value.id=window.$mcUtils.formatI18nKey(e))}}}},{type:le.INPUT,key:"avatar",label:`${t("ai.avatar")} URL`,props:{clearable:!0},render:()=>M("button",{class:"btn-no-style",onClick:async()=>{const e=await J.chooseFileToBase64({accept:"image/*"});"string"==typeof e&&(p.value.avatar=e)}},"🖼️")}],[{type:le.INPUT,key:"id",label:`ID (${t("ai.chuang_jian_hou_bu_k")})`,disabled:!c.value},{type:le.SELECT,options:X,key:"model",label:t("ai.model"),props:{tag:!0,filterable:!0}}],{type:le.INPUT,key:"desc",label:t("ai.desc")},{type:le.INPUT,key:"systemPrompt",label:t("ai.system_prompt"),props:{type:"textarea",rows:8}}])),f=()=>{if(u.value=!1,c.value)return void s.value.push(p.value);const e=s.value.findIndex((e=>e.id===p.value.id));e>-1&&s.value.splice(e,1,p.value),q.emit(j.ON_AI_CHARACTER_UPDATE)};return(e,a)=>{const l=N;return o(),r("div",Ge,[P(V,{class:"ai-option-ui","option-list":m.value},null,8,["option-list"]),P(l,{draggable:"",top:"10vh",width:"700",modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=e=>u.value=e),title:c.value?n(t)("actions.create"):n(t)("actions.edit")},{default:k((()=>[P(ae,{"form-schema":{model:p.value,rules:g.value,props:{labelPosition:"top"},formItems:y.value},onOnSubmit:f},null,8,["form-schema"])])),_:1},8,["modelValue","title"])])}}}),Ye={class:"ai-side-history"},We=e({__name:"SideHistory",setup(e){const{t:t}=D(),a=W(),{currentCharacter:l,allChatHistory:s,isCharacterListFinished:c,isAllChatHistory:u,currentHistoryGroup:d,currentHistory:p}=_e(),v=()=>{if(!l.value)return;console.log("[isCharacterListFinished]",c.value),console.log("[isAllChatHistory]",u.value);const e=G(),t={id:e,cid:l.value.id,title:"",timestamp:Date.now(),history:[]};s.value.push(t),a.currentChatHistoryId=e};i(l,(e=>{c.value&&u.value&&m()})),i(u,(e=>{e&&m()}));const m=()=>{setTimeout((()=>{l.value&&!d.value.length&&v(),!p.value&&d.value.length&&(a.currentChatHistoryId=d.value[0].id)}))},g=h((()=>{if(!l.value)return[];const e=t("ai.yu_current_character",[l.value.name]),i=()=>{s.value=s.value.filter((e=>e.cid!==l.value.id)).map(H)};return[{label:e,key:"history",hideExpandIcon:!0,actionRender:()=>ze([{label:`📤 ${t("actions.export")} JSON...`,props:{onClick:async()=>{const t=s.value.filter((e=>e.cid===l.value.id));window.$mcUtils.handleExportFile(await window.$mcUtils.promptGetFileName(e),JSON.stringify(t,null,2),".json")}}},{label:`📥 ${t("actions.import")} JSON...`,props:{onClick:async()=>{const e=await window.$mcUtils.handleImportJson();s.value=e||[];const t=s.value.filter((e=>e.cid===l.value.id)),a=ke(t,e);i(),s.value=a,window.$message.success("Import success!")}}},{label:`🗑️ ${t("actions.delete_all")}`,props:{onClick:()=>{window.$dialog.confirm(t("msgs.que_ren_shan_chu_ci"),t("actions.delete_all"),{type:"warning"}).then((()=>{i()})).catch()}}}]),children:[{label:`➕ ${t("ai.new_chat")}`,clickFn:()=>{v()}},...d.value.map(((l,i)=>({key:l.id,label:l.title||e,subtitle:z(l.timestamp),cls:a.currentChatHistoryId===l.id?"active":"",clickFn:()=>{a.currentChatHistoryId=l.id},actionRender:()=>ze([{label:`✍️ ${t("actions.rename")}`,props:{onClick:async()=>{const e=await window.$mcUtils.showInputPrompt({title:`${t("actions.rename")}: ${l.title}`,value:l.title});l.title=e}}},{label:`🗑️ ${t("actions.delete")}`,props:{onClick:()=>{const e=s.value.findIndex((e=>e.id===l.id));e>-1&&s.value.splice(e,1)}}}])})))]}]}));return(e,t)=>(o(),r("div",Ye,[P(V,{class:"ai-option-ui","option-list":n(g)},null,8,["option-list"])]))}}),Xe={class:"ai-chat-root vp-panel"},Ze=[d("svg",{width:"16",height:"16",xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 16 16"},[d("g",{fill:"none"},[d("path",{d:"M10.354 3.146a.5.5 0 0 1 0 .708L6.207 8l4.147 4.146a.5.5 0 0 1-.708.708l-4.5-4.5a.5.5 0 0 1 0-.708l4.5-4.5a.5.5 0 0 1 .708 0z",fill:"currentColor"})])],-1)],et=e({__name:"ChatRoot",setup(e){const t=W();return(e,a)=>(o(),r("div",Xe,[d("div",{class:v(["chat-sidebar",{_expand:n(t).isSidebarExpand}])},[P(Ke),P(We),d("button",{class:"btn-toggle-expand btn-no-style",onClick:a[0]||(a[0]=e=>n(t).isSidebarExpand=!n(t).isSidebarExpand)},Ze)],2),P(Oe)]))}});export{et as _,se as a};
